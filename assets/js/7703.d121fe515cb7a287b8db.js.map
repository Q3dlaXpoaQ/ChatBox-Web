{"version":3,"file":"assets/js/7703.d121fe515cb7a287b8db.js","mappings":"wNAkBOA,eAAeC,IACpB,MAAMC,QAAoB,IAAQC,cAC5BC,EAAW,CAAC,WAAY,QAAS,YAAa,cAC9CC,EAAcH,EAAYI,QAAQC,GAAQH,EAASI,MAAMC,GAAWF,EAAIG,WAAWD,OACzF,GAA2B,IAAvBJ,EAAYM,OACd,OAEF,MAAMC,EAAiB,IAAIC,IAAYR,GAGjCS,QAAiB,UACvB,IAAK,MAAMC,KAAeD,EAAU,CAElC,MAAME,QAAgB,IAAQC,QAAwB,KAAoBD,QAAQD,EAAYG,IAAK,MACnG,GAAKF,EAAL,CAGA,IAAK,MAAMG,KAAOH,EAAQI,SAAU,CAClC,IAAK,MAAMC,KAAQF,EAAyDG,UAAY,GAClFD,EAAIE,YACNX,EAAeY,OAAOH,EAAIE,YAG9B,IAAK,MAAME,KAAQN,EAAIO,OAAS,GAC1BD,EAAKF,YACPX,EAAeY,OAAOC,EAAKF,YAG/B,IAAK,MAAMI,KAAQR,EAAIS,cAAgB,GACnB,UAAdD,EAAKE,MAAoBF,EAAKJ,YAChCX,EAAeY,OAAOG,EAAKJ,YAG/B,IAAK,MAAMO,KAAQX,EAAIY,OAAS,GAC1BD,EAAKP,YACPX,EAAeY,OAAOM,EAAKP,YAG/B,GAA4B,IAAxBX,EAAeoB,KACjB,MAEJ,CAGIhB,EAAQiB,oBACVrB,EAAeY,OAAOR,EAAQiB,mBA7BhC,CA+BF,CAGA,MAAMC,EAAW,KAAcC,WAAWC,cACtCF,EAASG,eACXzB,EAAeY,OAAOU,EAASG,eAG7BH,EAASI,2BACX1B,EAAeY,OAAOU,EAASI,2BAGjC,IAAK,MAAM/B,KAAOK,QACV,IAAQ2B,QAAQhC,EAE1B,CApEsB,YAAlB,IAASsB,MACXW,YAAW,KACTvC,GAAiB,GAChB,I","sources":["webpack://xyz.chatboxapp.ce/./src/renderer/setup/storage_clear.ts"],"sourcesContent":["import { getDefaultStore } from 'jotai'\nimport type { Message, Session } from 'src/shared/types'\nimport { StorageKeyGenerator } from '@/storage/StoreStorage'\nimport { listSessionsMeta } from '@/stores/chatStore'\nimport { settingsStore } from '@/stores/settingsStore'\nimport platform from '../platform'\nimport storage from '../storage'\nimport * as atoms from '../stores/atoms'\n\n// 启动时执行消息图片清理\n// 只有网页版本需要清理，桌面版本存在本地、空间足够大无需清理\n// 同时也避免了桌面端疑似出现的“图片丢失”问题（可能不是bug，与开发环境有关？）\nif (platform.type !== 'desktop') {\n  setTimeout(() => {\n    tickStorageTask()\n  }, 10 * 1000) // 防止水合状态\n}\n\nexport async function tickStorageTask() {\n  const allBlobKeys = await storage.getBlobKeys()\n  const prefixes = ['picture:', 'file:', 'parseUrl-', 'parseFile-']\n  const storageKeys = allBlobKeys.filter((key) => prefixes.some((prefix) => key.startsWith(prefix)))\n  if (storageKeys.length === 0) {\n    return\n  }\n  const needDeletedSet = new Set<string>(storageKeys)\n\n  // 会话中还存在的图片、文件不需要删除\n  const sessions = await listSessionsMeta()\n  for (const sessionMeta of sessions) {\n    // 不从 atom 中获取，避免水合状态\n    const session = await storage.getItem<Session | null>(StorageKeyGenerator.session(sessionMeta.id), null)\n    if (!session) {\n      continue\n    }\n    for (const msg of session.messages) {\n      for (const pic of (msg as Message & { pictures: { storageKey: string }[] }).pictures || []) {\n        if (pic.storageKey) {\n          needDeletedSet.delete(pic.storageKey)\n        }\n      }\n      for (const file of msg.files || []) {\n        if (file.storageKey) {\n          needDeletedSet.delete(file.storageKey)\n        }\n      }\n      for (const part of msg.contentParts || []) {\n        if (part.type === 'image' && part.storageKey) {\n          needDeletedSet.delete(part.storageKey)\n        }\n      }\n      for (const link of msg.links || []) {\n        if (link.storageKey) {\n          needDeletedSet.delete(link.storageKey)\n        }\n      }\n      if (needDeletedSet.size === 0) {\n        return\n      }\n    }\n\n    // 会话助手头像不需要删除\n    if (session.assistantAvatarKey) {\n      needDeletedSet.delete(session.assistantAvatarKey)\n    }\n  }\n\n  // 用户头像不需要删除\n  const settings = settingsStore.getState().getSettings()\n  if (settings.userAvatarKey) {\n    needDeletedSet.delete(settings.userAvatarKey)\n  }\n  // 助手头像不需要删除\n  if (settings.defaultAssistantAvatarKey) {\n    needDeletedSet.delete(settings.defaultAssistantAvatarKey)\n  }\n\n  for (const key of needDeletedSet) {\n    await storage.delBlob(key)\n  }\n}\n"],"names":["async","tickStorageTask","allBlobKeys","getBlobKeys","prefixes","storageKeys","filter","key","some","prefix","startsWith","length","needDeletedSet","Set","sessions","sessionMeta","session","getItem","id","msg","messages","pic","pictures","storageKey","delete","file","files","part","contentParts","type","link","links","size","assistantAvatarKey","settings","getState","getSettings","userAvatarKey","defaultAssistantAvatarKey","delBlob","setTimeout"],"sourceRoot":""}