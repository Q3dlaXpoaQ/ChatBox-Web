"use strict";(self.webpackChunkxyz_chatboxapp_ce=self.webpackChunkxyz_chatboxapp_ce||[]).push([[6389],{14691:(e,s,t)=>{t.d(s,{l:()=>c});var n=t(74848),i=t(12335),r=t(48324),o=t(53479),a=t(96540),l=t(7824);const c=(0,a.forwardRef)((({onClick:e,tooltipLabel:s,isMobile:t=!1,size:a,variant:c},d)=>{const p=t?{...l.Y,color:"chatbox-secondary"}:{...l.y,size:a||l.y.size,variant:c||l.y.variant};return(0,n.jsx)(i.m,{label:s,withArrow:!0,position:"top-start",children:(0,n.jsx)(r.M,{ref:d,...p,onClick:e,children:(0,n.jsx)(o.A,{strokeWidth:1.8})})})}));c.displayName="ImageUploadButton"},8427:(e,s,t)=>{t.d(s,{F:()=>i});var n=t(74848);const i=(0,t(96540).forwardRef)((({onChange:e,accept:s="image/png, image/jpeg",multiple:t=!0,className:i="hidden",style:r},o)=>(0,n.jsx)("input",{ref:o,type:"file",accept:s,multiple:t,onChange:e,className:i,style:r||{display:"none"}})));i.displayName="ImageUploadInput"},96389:(e,s,t)=>{t.d(s,{A:()=>rs});var n=t(74848),i=t(99460),r=t(11507),o=t(69019),a=t(55917),l=t(40054),c=t(5055),d=t(48324),p=t(12335),u=t(32661),m=t(17826),x=t(18649),h=t(9763),g=t(84061),f=t(26782),j=t(44992),w=t(36118),b=t(42449),y=t(9203),k=t(35583),C=t(7641),v=t(24674),S=t(65262),z=t(46525),M=t(53479),I=t(41081),A=t(38365),W=t(34843),B=t(2543),K=t.n(B),N=t(96540),E=t(83882),D=t(34195),P=t(97386),T=t(84929);const L=(0,T.tG)("input-box-history",[]),F=()=>{const[e,s]=(0,N.useState)(-1),[t,n]=(0,W.fp)(L);return{inputBoxHistory:t,addInputBoxHistory:e=>{n([e,...t.filter((s=>s!==e))].slice(0,20))},clearInputBoxHistory:()=>{n([])},getPreviousHistoryInput:()=>{if(e<t.length-1){const n=e+1;return s(n),t[n]}},getNextHistoryInput:()=>{if(e>0){const n=e-1;return s(n),t[n]}},resetHistoryIndex:()=>{s(-1)}}};var U=t(27812),q=t(42446);var _=t(1740);const R={saveDraft:!0,timeout:300,isNewSession:!1};var $=t(70266),O=t(8097),H=t(84193),G=t(47571),V=t(45096),Y=t(70403),Z=t(24597),Q=t(88194);function X(e,s,t){const{session:n,refetch:i}=Q.wV(e),r=(0,G.E)({queries:s?.map((t=>({queryKey:["message-token-count",t],queryFn:()=>{if(!n)return null;const e=n.messages.find((e=>e.id===t));return e?e.tokenCountMap?{id:e.id,tokenCountMap:e.tokenCountMap,reused:!0}:(console.debug("useTokenCount","count token for message",e.id),{id:e.id,tokenCountMap:{deepseek:(0,V.PL)([e],"input",{modelId:"deepseek",provider:""}),default:(0,V.PL)([e],"input")},reused:!1}):null},enabled:!!e&&!!s,staleTime:3e4})))||[]});(0,N.useEffect)((()=>{if(!e||"new"===e)return;const s=r.filter((e=>e.data?.tokenCountMap&&!e.data?.reused)).map((e=>e.data));0!==s.length&&async function(e,s){const t=s.map((e=>e.id));Y.A.setQueriesData({predicate:e=>"message-token-count"===e.queryKey[0]&&t.includes(String(e.queryKey[1]))},(e=>({...e,reused:!0}))),await Q.Co(e,(e=>{if(!e)throw new Error("messages is null");return e.map((e=>{const t=s.find((s=>s.id===e.id));return t?{...e,tokenCountMap:t.tokenCountMap}:e}))}))}(e,s).then((()=>i()))}),[r,e,i]);return(0,N.useMemo)((()=>(0,B.sum)(r.map((e=>(0,V.wR)(t)?e.data?.tokenCountMap?.[Z.OG.deepseek]??0:e.data?.tokenCountMap?.[Z.OG.default]??0)))),[r,t])}var J=t(63635),ee=t(83250),se=t(82188),te=t(36920),ne=t(12268),ie=t(46929),re=t(25203);var oe=t(83884),ae=t(33351),le=t(45261),ce=t(90674),de=t(43639),pe=t(56755),ue=t(19007),me=t(59021),xe=t(95199),he=t(71216),ge=t(26869),fe=t(98389),je=t(41258),we=t(90397),be=t(74791);function ye({opened:e,onClose:s,session:t}){const{t:i}=(0,D.Bd)(),[r,a]=(0,N.useState)(!1),[d,p]=(0,N.useState)(""),[u,x]=(0,N.useState)(null),[h,g]=(0,N.useState)(!1),{sessionSettings:f}=(0,Q.Pf)(t.id),j=(0,N.useMemo)((()=>d.split("\n").filter((e=>""!==e.trim())).slice(-3).join("\n")),[d]),w=(0,N.useRef)(null);return(0,N.useEffect)((()=>{e||(a(!1),p(""),x(null),g(!1),w.current&&(w.current.abort(),w.current=null))}),[e]),(0,n.jsx)(we.aF,{opened:e,onClose:r||h?()=>{w.current?.abort(),w.current=null,s()}:s,title:i("Compress Conversation"),centered:!0,size:"md",children:(0,n.jsxs)(o.B,{gap:"md",children:[!r&&!h&&!u&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(m.E,{children:i("This will summarize the current conversation and start a new thread with the compressed context. Continue?")}),(0,n.jsxs)(l.s,{gap:"sm",justify:"flex-end",children:[(0,n.jsx)(c.$,{variant:"subtle",onClick:s,children:i("Cancel")}),(0,n.jsx)(c.$,{onClick:async()=>{a(!0),x(null),p("");try{if(!f)return null;const e=re.dK.getState().getSettings();if(!t)return null;const n=await(0,xe.P)(),i=(0,me.E1)(f,e,{uuid:""},n),r=t.messages.slice(-(f.maxContextMessageCount||0)),o=fe.jt(r,he.m[e.language]);let l="";const c=e=>{const s=e.contentParts?.filter((e=>"text"===e.type)).map((e=>e.text)).join("")||"";l=s,p(s)},d=new AbortController;if(w.current=d,await(0,ge.gM)(i,{sessionId:t.id,messages:o,onResultChangeWithCancel:c,providerOptions:f.providerOptions},d.signal),d.signal.aborted)return;await(0,je.Sv)(t.id,l),g(!0),a(!1),setTimeout((()=>{s()}),1500)}catch(e){console.error("Compression failed:",e),x(e instanceof Error?e.message:"Compression failed")}finally{a(!1),w.current?.abort(),w.current=null}},children:i("Confirm")})]})]}),r&&(0,n.jsx)(m.E,{size:"sm",style:{whiteSpace:"pre-wrap",height:"60px",overflow:"hidden",lineHeight:"20px"},children:j||i("Generating summary...")}),h&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(l.s,{align:"center",gap:"xs",mb:"sm",children:[(0,n.jsx)(be.n,{icon:ue.A,size:20,color:"var(--chatbox-tint-success)"}),(0,n.jsx)(m.E,{size:"sm",c:"green",fw:500,children:i("Compression completed successfully!")})]}),(0,n.jsx)(m.E,{size:"xs",c:"dimmed",mt:"xs",children:i("Starting new thread...")})]}),u&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(m.E,{c:"red",children:u}),(0,n.jsx)(l.s,{gap:"sm",justify:"flex-end",children:(0,n.jsx)(c.$,{onClick:s,children:i("Close")})})]})]})})}var ke=t(4913),Ce=t(53987);const ve=({onSelect:e,children:s,...t})=>{const{providers:i}=(0,$.u)(),r=i.filter((e=>[Z.wU.OpenAI,Z.wU.Azure,""].includes(e.id))),o=(0,ke.B)({onDropdownClose:()=>{o.resetSelectedOption(),o.focusTarget()}});return(0,n.jsxs)(Ce.G,{store:o,width:260,position:"top",withinPortal:!0,...t,onOptionSubmit:s=>{e?.(s,"DALL-E-3"),o.closeDropdown()},children:[(0,n.jsx)(Ce.G.Target,{targetType:"button",children:(0,n.jsx)("button",{onClick:()=>o.toggleDropdown(),className:"border-none bg-transparent p-0 flex",children:s})}),(0,n.jsx)(Ce.G.Dropdown,{children:(0,n.jsxs)(Ce.G.Options,{mah:500,style:{overflowY:"auto"},children:[(0,n.jsx)(Ce.G.Option,{value:Z.wU.ChatboxAI,c:"chatbox-primary",children:"Chatbox AI"}),r.map((e=>(0,n.jsxs)(Ce.G.Option,{value:e.id,c:"chatbox-primary",children:[e.name," (DALL-E-3)"]},e.id)))]})})]})};var Se=t(31074),ze=t(52284);const Me=t(2552),Ie=Me.keys().map((e=>({name:e.replace("./","").replace(".png",""),src:Me(e)})));function Ae(e){const{className:s,size:t=24,provider:i,providerName:r}=e,{providers:o}=(0,$.u)(),a=o.find((e=>e.id===i));if(a?.isCustom)return a.iconUrl?(0,n.jsx)(Se._,{w:t,h:t,src:a.iconUrl,alt:a.name}):(0,n.jsx)(ze.A,{providerId:a.id,providerName:a.name,size:t});const l=Ie.find((e=>e.name===i))?.src;return l?(0,n.jsx)(Se._,{w:t,h:t,src:l,className:s,alt:`${r||i} image icon`}):r?(0,n.jsx)(ze.A,{providerId:i,providerName:r,size:t}):null}var We=t(64999),Be=t(47972),Ke=t(28775),Ne=t(20899),Ee=t(39681),De=t(80697),Pe=t(10461);const Te=e=>{const{data:s}=(0,Pe.IM)(),{t}=(0,D.Bd)();return(0,n.jsxs)(u.W,{position:"top",shadow:"md",keepMounted:!0,transitionProps:{transition:"fade-up",duration:300},children:[(0,n.jsx)(u.W.Target,{children:e.children}),(0,n.jsxs)(u.W.Dropdown,{className:"min-w-40",children:[(0,n.jsxs)(l.s,{justify:"space-between",children:[(0,n.jsx)(u.W.Label,{fw:600,children:t("Knowledge Base")}),(0,n.jsx)(u.W.Label,{children:(0,n.jsx)(Ee.N_,{to:"/settings/knowledge-base",children:(0,n.jsx)(Be.A,{size:16,color:"var(--chatbox-tint-tertiary)"})})})]}),s?.map((s=>(0,n.jsx)(u.W.Item,{onClick:()=>e.onSelect?.(s),children:(0,n.jsxs)(l.s,{justify:"space-between",align:"center",gap:"xs",children:[(0,n.jsxs)(l.s,{gap:"xs",align:"center",children:[(0,n.jsx)(Ke.A,{size:14}),(0,n.jsx)(m.E,{c:s.id===e.currentKnowledgeBaseId?"chatbox-brand":"",children:s.name})]}),s.id===e.currentKnowledgeBaseId&&(0,n.jsx)(Ne.A,{size:14,color:"var(--chatbox-tint-brand)"})]})},s.id))),0===s?.length&&(0,n.jsx)(We.Y,{justify:"center",className:"w-full",children:(0,n.jsx)(Ee.N_,{to:"/settings/knowledge-base",className:"w-full",children:(0,n.jsxs)(c.$,{size:"xs",variant:"light",w:"100%",children:[(0,n.jsx)(De.A,{size:14,className:"mr-1"}),t("Create")]})})})]})]})};var Le=t(95596),Fe=t(2432),Ue=t(20709),qe=t(64088),_e=t(79094),Re=t(40013);const $e=({status:e})=>e?.error?(0,n.jsx)(p.m,{label:e.error,withArrow:!0,color:"chatbox-error",multiline:!0,w:260,children:(0,n.jsx)("div",{className:"rounded-full size-[6.6px] bg-red-500"})}):(0,n.jsx)("div",{className:(0,J.cn)("rounded-full size-[6.6px]",(!e||"idle"===e?.state)&&"bg-gray-500","running"===e?.state&&"bg-green-500","starting"===e?.state&&"bg-blue-500 animate-pulse","stopping"===e?.state&&"bg-yellow-500 animate-pulse",e?.error&&"bg-red-500")}),Oe=({item:e,onEnabledChange:s})=>{const t=(0,Ue.d)(e.id);return(0,n.jsx)(u.W.Item,{c:"chatbox-primary",leftSection:(0,n.jsx)($e,{status:t}),rightSection:(0,n.jsx)(Fe.d,{checked:e.enabled,size:"xs",disabled:"starting"===t?.state||"stopping"===t?.state,onChange:t=>s(e.id,t.currentTarget.checked)}),children:e.name})},He=({children:e})=>{const{t:s}=(0,D.Bd)(),t=(0,re.TR)(),i=(0,Re.PD)(),r=(0,Ue.v)(),o=t.servers.filter((e=>e.enabled)).length+t.enabledBuiltinServers.length,[a,p]=(0,N.useState)(!1);return(0,n.jsxs)(u.W,{trigger:"hover",openDelay:100,closeDelay:100,opened:a,onChange:p,shadow:"md",withArrow:!0,width:240,closeOnItemClick:!1,position:"top-start",transitionProps:{transition:"pop",duration:200},children:[(0,n.jsx)(u.W.Target,{children:e(o)}),(0,n.jsxs)(u.W.Dropdown,{children:[(0,n.jsxs)(l.s,{justify:"space-between",align:"center",children:[(0,n.jsx)(u.W.Label,{fw:600,children:"MCP"}),(0,n.jsx)(u.W.Label,{children:(0,n.jsx)(d.M,{variant:"subtle",size:20,onClick:()=>{p(!1),(0,qe.Ox)("/mcp")},children:(0,n.jsx)(be.n,{icon:Be.A,size:16,color:"var(--chatbox-tint-tertiary)"})})})]}),i&&(0,n.jsxs)(n.Fragment,{children:[_e.u.map((e=>(0,n.jsx)(Oe,{item:{id:e.id,name:e.name,enabled:t.enabledBuiltinServers.includes(e.id)},onEnabledChange:r},e.id))),(0,n.jsx)(u.W.Divider,{})]}),t.servers.map((e=>(0,n.jsx)(Oe,{item:e,onEnabledChange:r},e.id))),!t.servers.length&&!t.enabledBuiltinServers.length&&(0,n.jsx)(We.Y,{justify:"center",children:(0,n.jsx)(Ee.N_,{to:"/settings/mcp",children:(0,n.jsx)(c.$,{size:"xs",my:12,variant:"outline",children:s("Add your first MCP server")})})})]})]})};var Ge=t(51660),Ve=t(14691),Ye=t(8427);function Ze(e,s,t,n=6){const i=ie.CB.linkUniqKey(s),r=new Map(e.preprocessingPromises.links);r.delete(i);const o=[...e.preprocessedLinks.filter((e=>e.url!==s)),t].slice(-n);return{...e,preprocessedLinks:o,preprocessingStatus:{...e.preprocessingStatus,links:{...e.preprocessingStatus.links,[i]:t.error?"error":"completed"}},preprocessingPromises:{...e.preprocessingPromises,links:r}}}function Qe(e,s,t,n=10){const i=ie.CB.fileUniqKey(s),r=new Map(e.preprocessingPromises.files);r.delete(i);const o=[...e.preprocessedFiles,t].slice(-n);return{...e,preprocessedFiles:o,preprocessingStatus:{...e.preprocessingStatus,files:{...e.preprocessingStatus.files,[i]:t.error?"error":"completed"}},preprocessingPromises:{...e.preprocessingPromises,files:r}}}function Xe(e,s){const t=ie.CB.fileUniqKey(s),n=new Map(e.preprocessingPromises.files);return n.delete(t),{...e,preprocessedFiles:e.preprocessedFiles.filter((e=>e.file.name!==s.name)),preprocessingStatus:{...e.preprocessingStatus,files:{...e.preprocessingStatus.files,[t]:void 0}},preprocessingPromises:{...e.preprocessingPromises,files:n}}}var Je=t(25780),es=t(4864);const ss=({currentInputTokens:e,contextTokens:s,totalTokens:t,contextWindow:i,currentMessageCount:r,maxContextMessageCount:o,children:a,onCompressClick:c})=>{const{t:d}=(0,D.Bd)(),p=(0,O.L0)();return(0,n.jsxs)(u.W,{trigger:p?"click":"hover",openDelay:100,closeDelay:100,position:"top",shadow:"md",keepMounted:!0,transitionProps:{transition:"pop",duration:200},children:[(0,n.jsx)(u.W.Target,{children:a}),(0,n.jsxs)(u.W.Dropdown,{className:"min-w-56",children:[(0,n.jsx)(u.W.Label,{fw:600,children:d("Estimated Token Usage")}),(0,n.jsx)(u.W.Item,{disabled:!0,style:{cursor:"default"},children:(0,n.jsxs)(l.s,{justify:"space-between",align:"center",gap:"xs",children:[(0,n.jsxs)(m.E,{size:"sm",children:[d("Current input"),":"]}),(0,n.jsx)(m.E,{size:"sm",fw:500,children:(0,P.ZV)(e)})]})}),(0,n.jsx)(u.W.Item,{disabled:!0,style:{cursor:"default"},children:(0,n.jsxs)(l.s,{justify:"space-between",align:"center",gap:"xs",children:[(0,n.jsxs)(m.E,{size:"sm",children:[d("Context"),":"]}),(0,n.jsx)(m.E,{size:"sm",fw:500,children:(0,P.ZV)(s)})]})}),void 0!==o&&void 0!==r&&(0,n.jsx)(u.W.Item,{disabled:!0,style:{cursor:"default"},children:(0,n.jsxs)(l.s,{justify:"space-between",align:"center",gap:"xs",children:[(0,n.jsxs)(m.E,{size:"sm",children:[d("Context messages"),":"]}),(0,n.jsx)(m.E,{size:"sm",fw:500,children:o===Number.MAX_SAFE_INTEGER?r:`${r} / ${o}`})]})}),(0,n.jsx)(u.W.Divider,{}),(0,n.jsx)(u.W.Item,{disabled:!0,style:{cursor:"default"},children:(0,n.jsxs)(l.s,{justify:"space-between",align:"center",gap:"xs",children:[(0,n.jsxs)(m.E,{size:"sm",fw:600,children:[d("Total"),":"]}),(0,n.jsx)(m.E,{size:"sm",fw:600,children:(0,P.ZV)(t)})]})}),i&&(0,n.jsx)(u.W.Item,{disabled:!0,style:{cursor:"default"},children:(0,n.jsxs)(l.s,{justify:"space-between",align:"center",gap:"xs",children:[(0,n.jsxs)(m.E,{size:"sm",children:[d("Model limit"),":"]}),(0,n.jsx)(m.E,{size:"sm",fw:500,children:(0,P.ZV)(i)})]})}),c&&s>0&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(u.W.Divider,{}),(0,n.jsx)(u.W.Item,{leftSection:(0,n.jsx)(be.n,{icon:es.A,size:16}),onClick:c,color:"chatbox-brand",children:d("Compress Conversation")})]})]})]})};var ts=t(51154);const ns=(0,N.forwardRef)((({sessionId:e,sessionType:s="chat",generating:t=!1,model:z,fullWidth:M=!1,onSelectModel:I,onSubmit:A,onStopGenerating:T,onStartNewThread:L,onRollbackThread:G,onClickSessionSettings:Y},ue)=>{const{t:me}=(0,D.Bd)(),xe=(0,O.L0)(),{height:he}=(0,x.l)(),ge=(0,re.C$)((e=>e.pasteLongTextAsAFile)),fe=(0,re.C$)((e=>e.shortcuts)),je=(0,q.j)((e=>e.widthFull))||M,we=(0,q.j)((e=>e.inputBoxWebBrowsingMode)),ke=(0,q.j)((e=>e.setInputBoxWebBrowsingMode)),Ce=e,Se="new"===Ce,{messageInput:ze,setMessageInput:Me,clearDraft:Ie}=function(e="",s={}){const t={...R,...s},[n,i]=(0,N.useState)(e),r=(0,W.md)(_.sw),o=(0,N.useRef)(e),a=(0,N.useMemo)((()=>t.isNewSession?"new-chat":`draft-${r}`),[r,t.isNewSession]),l=(0,N.useCallback)((()=>{const e=localStorage.getItem(a);e&&(i(e),o.current=e)}),[a]),c=(0,N.useMemo)((()=>(0,B.debounce)((e=>{localStorage.setItem(a,e)}),t.timeout)),[a,t.timeout]),d=(0,N.useCallback)((e=>{let s;s="string"==typeof e?e:e(o.current),o.current=s,c(s)}),[c]),p=(0,N.useCallback)((e=>{i(e),d(e)}),[d]),u=(0,N.useCallback)((()=>{i(""),o.current="",localStorage.removeItem(a),c.cancel()}),[a,c]);return(0,N.useEffect)((()=>{t.saveDraft&&l()}),[l,t.saveDraft]),{messageInput:n,setMessageInput:p,clearDraft:u,storeDraft:d,restoreDraft:l}}("",{isNewSession:Se}),[We,Be]=(0,W.fp)(U.Ym(Ce||"new")),Ke=We.pictureKeys||[],Ne=We.attachments||[],{session:Ee}=(0,Q.wV)(e||null),{sessionSettings:De}=(0,Q.Pf)(e||null),Pe=(0,N.useMemo)((()=>Se?null:De?.maxContextMessageCount&&Ee?.messages.length?Ee.messages.filter((e=>!e.generating)).map((e=>e.id)).slice(-(De.maxContextMessageCount||0)):null),[Se,De?.maxContextMessageCount,Ee?.messages]),{knowledgeBase:Fe,setKnowledgeBase:Ue}=function({isNewSession:e}){const s=(0,W.md)(U.sw),t=(0,q.j)((e=>e.newSessionState)),n=(0,q.j)((e=>e.setNewSessionState)),i=(0,q.j)((e=>e.sessionKnowledgeBaseMap)),r=(0,q.j)((e=>e.addSessionKnowledgeBase)),o=(0,q.j)((e=>e.removeSessionKnowledgeBase));return{knowledgeBase:e?t.knowledgeBase:s?i[s]:void 0,setKnowledgeBase:(0,N.useCallback)((t=>{e?n((e=>({...e,knowledgeBase:t}))):s&&(void 0===t?o(s):r(s,t))}),[s,e,n,r,o])}}({isNewSession:Se}),[qe,_e]=(0,N.useState)(!1),[Re,$e]=(0,W.fp)(U.Vo(Ce||"new")),[Oe,es]=(0,N.useState)(!1);(0,N.useEffect)((()=>{const e=ce.uu(ze,Ke,We.preprocessedFiles,We.preprocessedLinks);Be((s=>({...s,text:ze,pictureKeys:Ke,attachments:Ne,links:Re,message:e})))}),[ze,Ke,Ne,Re,We.preprocessedFiles,We.preprocessedLinks,Be]);const ns=(0,N.useRef)(null),rs=(0,N.useRef)(null),os=(0,N.useMemo)((()=>{const e=Object.values(We.preprocessingStatus.files||{}).some((e=>"processing"===e)),s=Object.values(We.preprocessingStatus.links||{}).some((e=>"processing"===e));return e||s}),[We.preprocessingStatus]),as=(0,N.useMemo)((()=>!(ze.trim()||Re?.length||Ne?.length||Ke?.length)),[ze,Re,Ne,Ke]),{providers:ls}=(0,$.u)(),cs=(0,N.useMemo)((()=>{if(!z)return me("Select Model");const e=ls.find((e=>e.id===z.provider)),s=(e?.models||e?.defaultSettings?.models)?.find((e=>e.modelId===z.modelId));return`${s?.nickname||z.modelId}`}),[ls,z,me]),ds=(0,N.useMemo)((()=>{if(!z)return null;const e=ls.find((e=>e.id===z.provider));return(e?.models||e?.defaultSettings?.models)?.find((e=>e.modelId===z.modelId))}),[ls,z]),{currentInputTokens:ps,contextTokens:us,totalTokens:ms}=function(e,s,t,n){const[i,r]=(0,N.useState)(0),o=X(e,t,n),[a]=(0,H.o)(s,300);return(0,N.useEffect)((()=>{a?(console.debug("useTokenCount","calculate current input tokens"),r((0,V.PL)([a],"input",{modelId:n?.modelId||"",provider:n?.provider||""}))):r(0)}),[a,n?.modelId,n?.provider]),{currentInputTokens:i,contextTokens:o,totalTokens:i+o}}(Ce||null,We.message,Pe,z),[xs,hs]=(0,N.useState)(!1);(0,N.useEffect)((()=>{if(xs){const e=()=>{hs(!1),document.removeEventListener("click",e)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}}}),[xs]);const[gs,fs]=(0,N.useState)(!1);(0,N.useEffect)((()=>{if(gs){const e=setTimeout((()=>{fs(!1)}),5e3);return()=>{clearTimeout(e)}}}),[gs]);const js=(0,N.useRef)(null);(0,N.useImperativeHandle)(ue,(()=>({setQuote:e=>{Me((s=>`${s}\n\n${e}`)),le.Wp(),le.iH()}})),[Me]);const{addInputBoxHistory:ws,getPreviousHistoryInput:bs,getNextHistoryInput:ys,resetHistoryIndex:ks}=F(),Cs=(0,N.useRef)(),vs=async(e=!0)=>{if(!(as||t||Oe||os)){if(!z)return await(s=100,new Promise((e=>{setTimeout(e,s)}))),Cs.current&&clearTimeout(Cs.current),hs(!0),void(Cs.current=setTimeout((()=>hs(!1)),5e3));var s;es(!0);try{if(!We.message)return void console.error("No constructed message available");const s={constructedMessage:We.message,needGenerating:e};Ie(),$e([]),Be({text:"",pictureKeys:[],attachments:[],links:[],preprocessedFiles:[],preprocessedLinks:[],preprocessingStatus:{files:{},links:{}},preprocessingPromises:{files:new Map,links:new Map},message:void 0}),fs(!1),"mobile"!==te.A.type&&We.message&&ws(We.message.contentParts.find((e=>"text"===e.type))?.text||""),await(A?.(s)),(0,ee.i)("send_message",{event_category:"user"})}catch(e){console.error("Error submitting message:",e),de.W(e?.message||me("An error occurred while sending the message."))}finally{es(!1)}}},Ss=(0,N.useCallback)((e=>{const s=e.target.value;Me(s),ks()}),[Me,ks]),zs=()=>{const e=L?.();e&&fs(!0)},Ms=e=>{Be((s=>function(e,s){const t=ie.CB.linkUniqKey(s);return{...e,preprocessingStatus:{...e.preprocessingStatus,links:{...e.preprocessingStatus.links,[t]:"processing"}}}}(s,e)));const s=ce.t$(e,{provider:z?.provider||"",modelId:z?.modelId||""}).then((s=>{Be((t=>Ze(t,e,s,6)))})).catch((s=>{Be((t=>Ze(t,e,{url:e,title:"",content:"",storageKey:"",error:s?.message||"Failed to preprocess the link."},6)))}));Be((t=>function(e,s,t){const n=ie.CB.linkUniqKey(s),i=new Map(e.preprocessingPromises.links);return i.set(n,t),{...e,preprocessingPromises:{...e.preprocessingPromises,links:i}}}(t,e,s)))},Is=e=>{Be((s=>function(e,s){const t=ie.CB.fileUniqKey(s);return{...e,preprocessingStatus:{...e.preprocessingStatus,files:{...e.preprocessingStatus.files,[t]:"processing"}}}}(s,e)));const s=ce.vV(e,{provider:z?.provider||"",modelId:z?.modelId||""}).then((s=>{Be((t=>Qe(t,e,s,10)))})).catch((s=>{Be((t=>Qe(t,e,{file:e,content:"",storageKey:"",error:s?.message||"Failed to preprocess the file."},10)))}));Be((t=>function(e,s,t){const n=ie.CB.fileUniqKey(s),i=new Map(e.preprocessingPromises.files);return i.set(n,t),{...e,preprocessingPromises:{...e.preprocessingPromises,files:i}}}(t,e,s)))},As=async e=>{let s=[...Re||[],...e.map((e=>({url:e})))];s=K().uniqBy(s,"url"),s=s.slice(-6),$e(s);for(let t=0;t<Math.min(e.length,6);t++){const n=e[t];s.findIndex((e=>e.url===n))<6&&Ms(n)}},Ws=async e=>{for(const s of e)if(s.type.startsWith("image/")){const e=await se.kZ(s),t=ie.CB.picture("input-box");await ne.A.setBlob(t,e),Be((e=>({...e,pictureKeys:[...e.pictureKeys||[],t].slice(-8)})))}else Be((e=>{const t=e.attachments.find((e=>ie.CB.fileUniqKey(e)===ie.CB.fileUniqKey(s)))?e.attachments:[...e.attachments||[],s].slice(-10);return t.findIndex((e=>e.name===s.name&&e.lastModified===s.lastModified))<10&&Is(s),{...e,attachments:t}}))},Bs=e=>{e.target.files&&(Ws(Array.from(e.target.files)),e.target.value="",le.Wp())},Ks=()=>{ns.current?.click()},Ns=()=>{rs.current?.click()},Es=async()=>{const e=await i.Ay.show("attach-link");e&&As(e)},{getRootProps:Ds,getInputProps:Ps}=(0,E.VB)({onDrop:e=>{Ws(e)},noClick:!0,noKeyboard:!0}),Ts=(0,q.j)((e=>e.quote)),Ls=(0,q.j)((e=>e.setQuote));(0,N.useEffect)((()=>{""!==Ts&&(Ls(""),Me((e=>e?e+"\n".repeat(Math.max(0,2-(e.match(/(\n)+$/)?.[0].length||0)))+Ts:Ts)),le.Wp(),le.iH())}),[Ts]);const Fs=(0,N.useCallback)((e=>{e&&e.id!==Fe?.id?(Ue((0,B.pick)(e,"id","name")),(0,ae.s)("knowledge_base_enabled",{knowledge_base_name:e.name})):(Ue(void 0),(0,ae.s)("knowledge_base_disabled",{knowledge_base_name:Fe?.name}))}),[Fe,Ue]);return(0,n.jsxs)(r.a,{pt:0,pb:xe?"md":"sm",px:xe?"0.3rem":"1rem",id:le.RK,...Ds(),children:[(0,n.jsx)("input",{className:"hidden",...Ps()}),(0,n.jsxs)(o.B,{className:(0,J.cn)("rounded-lg sm:rounded-md bg-chatbox-background-secondary border border-solid border-chatbox-border-primary justify-between",je?"w-full":"max-w-4xl mx-auto",!xe&&"min-h-[92px]"),gap:0,children:[(0,n.jsx)(a.T,{unstyled:!0,classNames:{input:"block w-full outline-none border-none px-sm pt-sm pb-sm resize-none bg-transparent text-chatbox-tint-primary"},size:"sm",id:le.tY,ref:js,placeholder:me("Type your question here...")||"",bg:"transparent",autosize:!0,minRows:1,maxRows:Math.max(3,Math.floor(he/100)),value:ze,autoFocus:!xe,onChange:Ss,onKeyDown:e=>{const s={"":!1,Enter:!(13!==e.keyCode||e.shiftKey||e.ctrlKey||e.altKey||e.metaKey),"CommandOrControl+Enter":13===e.keyCode&&(e.ctrlKey||e.metaKey)&&!e.shiftKey,"Ctrl+Enter":13===e.keyCode&&e.ctrlKey&&!e.shiftKey,"Command+Enter":13===e.keyCode&&e.metaKey,"Shift+Enter":13===e.keyCode&&e.shiftKey,"Ctrl+Shift+Enter":13===e.keyCode&&e.ctrlKey&&e.shiftKey};if(s[fe.inputBoxSendMessage]){if("mobile"===te.A.type&&xe&&"Enter"===fe.inputBoxSendMessage)return;return e.preventDefault(),void vs()}if(s[fe.inputBoxSendMessageWithoutResponse])return e.preventDefault(),void vs(!1);if(("ArrowUp"===e.key||"ArrowDown"===e.key)&&js.current&&js.current===document.activeElement&&(0===ze.length||window.getSelection()?.toString()===ze))if(e.preventDefault(),"ArrowUp"===e.key){const e=bs();void 0!==e&&(Me(e),setTimeout((()=>js.current?.select()),10))}else if("ArrowDown"===e.key){const e=ys();void 0!==e&&(Me(e),setTimeout((()=>js.current?.select()),10))}},onPaste:e=>{if("picture"!==s&&e.clipboardData?.items){let s=!1;for(let t=0;t<e.clipboardData.items.length;t++){const n=e.clipboardData.items[t];if("file"!==n.kind)s=!0,"string"===n.kind&&"text/plain"===n.type&&n.getAsString((e=>{const s=e.trim();if(s.startsWith("http://")||s.startsWith("https://")){const e=s.split(/\s+/).map((e=>e.trim())).filter((e=>e.startsWith("http://")||e.startsWith("https://")));As(e)}if(ge&&s.length>3e3){const s=new File([e],`pasted_text_${Ne?.length||0}.txt`,{type:"text/plain"});Ws([s]),Me(ze)}}));else{const e=n.getAsFile();e&&Ws([e])}}s||e.preventDefault()}}}),(!!Ke.length||!!Ne.length||!!Re.length)&&(0,n.jsxs)(l.s,{px:"sm",pb:"xs",align:"center",wrap:"wrap",onClick:()=>le.Wp(),children:[Ke?.map((e=>(0,n.jsx)(pe.pv,{storageKey:e,onDelete:()=>(async e=>{Be((s=>({...s,pictureKeys:(s.pictureKeys||[]).filter((s=>s!==e))})))})(e)},e))),Ne?.map((e=>(0,n.jsx)(pe.q9,{name:e.name,fileType:e.type,status:We.preprocessingStatus.files[ie.CB.fileUniqKey(e)],onDelete:()=>{Be((s=>({...Xe(s,e),attachments:(s.attachments||[]).filter((s=>ie.CB.fileUniqKey(s)!==ie.CB.fileUniqKey(e)))})))}},ie.CB.fileUniqKey(e)))),Re?.map((e=>(0,n.jsx)(pe.is,{url:e.url,status:We.preprocessingStatus.links[ie.CB.linkUniqKey(e.url)],onDelete:()=>{$e(Re.filter((s=>s.url!==e.url))),Be((s=>function(e,s){const t=ie.CB.linkUniqKey(s),n=new Map(e.preprocessingPromises.links);return n.delete(t),{...e,preprocessedLinks:e.preprocessedLinks.filter((e=>e.url!==s)),preprocessingStatus:{...e.preprocessingStatus,links:{...e.preprocessingStatus.links,[t]:void 0}},preprocessingPromises:{...e.preprocessingPromises,links:n}}}(s,e.url)))}},ie.CB.linkUniqKey(e.url))))]}),(0,n.jsxs)(l.s,{px:"sm",pb:"sm",align:"flex-end",justify:"space-between",gap:"0",wrap:"wrap",children:[(0,n.jsxs)(l.s,{gap:"md",flex:"0 1 auto",className:"!hidden sm:!flex",children:["picture"!==s&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(Ye.F,{ref:ns,onChange:Bs}),(0,n.jsx)("input",{type:"file",ref:rs,className:"hidden",onChange:Bs,multiple:!0}),(0,n.jsx)(is,{onImageUploadClick:Ks,onFileUploadClick:Ns,handleAttachLink:Es,t:me}),oe.o.mcp&&(0,n.jsx)(He,{children:e=>e>0?(0,n.jsx)(c.$,{radius:"md",variant:"light",h:"auto",w:"auto",px:"xs",py:0,children:(0,n.jsxs)(l.s,{gap:"3xs",align:"center",children:[(0,n.jsx)(be.n,{icon:h.A,strokeWidth:1.8,size:22}),(0,n.jsx)("span",{children:e})]})}):(0,n.jsx)(d.M,{size:24,variant:"subtle",color:"chatbox-secondary",children:(0,n.jsx)(be.n,{icon:h.A,size:22,strokeWidth:1.8})})}),oe.o.knowledgeBase&&(0,n.jsx)(Te,{currentKnowledgeBaseId:Fe?.id,onSelect:Fs,children:(0,n.jsx)(d.M,{size:24,variant:"subtle",color:Fe?"chatbox-brand":"chatbox-secondary",children:(0,n.jsx)(be.n,{icon:g.A,size:22,strokeWidth:1.8})})}),(0,n.jsx)(p.m,{label:(0,n.jsxs)(o.B,{align:"center",gap:"xxs",pb:"xxs",children:[(0,n.jsx)("div",{className:"whitespace-nowrap",children:me("Web Browsing")}),(0,n.jsx)(l.s,{align:"center",children:(0,n.jsx)(Ge.D,{keys:fe.inputBoxWebBrowsingMode.split("+"),size:"small",opacity:.7})})]}),withArrow:!0,position:"top",children:(0,n.jsx)(ts.u,{active:we,onClick:()=>{ke(!we),le.Wp()}})}),gs?(0,n.jsx)(p.m,{label:me("Back to Previous"),withArrow:!0,position:"top-start",children:(0,n.jsx)(d.M,{size:24,variant:"subtle",color:"chatbox-secondary",onClick:()=>{const e=G?.();e&&fs(!1)},children:(0,n.jsx)(be.n,{icon:f.A,size:22,strokeWidth:1.8})})}):(0,n.jsx)(p.m,{label:(0,n.jsxs)(o.B,{align:"center",gap:"xxs",pb:"xxs",children:[(0,n.jsx)("div",{className:"whitespace-nowrap",children:me("Start a New Thread")}),(0,n.jsx)(l.s,{align:"center",children:(0,n.jsx)(Ge.D,{keys:fe.messageListRefreshContext.split("+"),size:"small",opacity:.7})})]}),withArrow:!0,position:"top-start",children:(0,n.jsx)(d.M,{size:24,variant:"subtle",color:"chatbox-secondary",disabled:!L,onClick:zs,children:(0,n.jsx)(be.n,{icon:j.A,size:22,strokeWidth:1.8})})})]}),z?.provider===Z.wU.ChatboxAI&&"picture"===s&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(Ye.F,{ref:ns,onChange:Bs}),(0,n.jsx)(Ve.l,{onClick:Ks,tooltipLabel:me("Attach Image")})]}),(0,n.jsx)(Je.o,{onClick:Y,tooltipLabel:me("Customize settings for the current conversation"),disabled:!Y})]}),(0,n.jsx)(l.s,{className:"sm:!hidden",gap:"xs",children:"picture"!==s?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(is,{onImageUploadClick:Ks,onFileUploadClick:Ns,handleAttachLink:Es,t:me,size:20,iconSize:void 0}),(0,n.jsx)(ts.u,{active:we,onClick:()=>{ke(!we),le.Wp()},isMobile:!0}),(0,n.jsxs)(u.W,{trigger:xe?"click":"hover",openDelay:100,closeDelay:100,keepMounted:!0,transitionProps:{transition:"pop",duration:200},children:[(0,n.jsx)(u.W.Target,{children:(0,n.jsx)(d.M,{variant:"transparent",w:20,h:20,miw:20,mih:20,bd:"none",color:"chatbox-secondary",children:(0,n.jsx)(be.n,{icon:w.A,size:20,strokeWidth:1.8})})}),(0,n.jsxs)(u.W.Dropdown,{children:[(0,n.jsx)(u.W.Item,{leftSection:(0,n.jsx)(be.n,{icon:b.A,size:16}),onClick:zs,children:me("New Thread")}),(0,n.jsx)(u.W.Item,{leftSection:(0,n.jsx)(be.n,{icon:y.A,size:16}),onClick:Y,children:me("Conversation Settings")})]})]})]}):(0,n.jsxs)(n.Fragment,{children:[z?.provider===Z.wU.ChatboxAI&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(Ye.F,{ref:ns,onChange:Bs}),(0,n.jsx)(Ve.l,{onClick:Ks,tooltipLabel:me("Add images"),isMobile:!0})]}),(0,n.jsx)(Je.o,{onClick:Y,tooltipLabel:me("Customize settings for the current conversation"),disabled:!Y,isMobile:!0})]})}),(0,n.jsxs)(l.s,{gap:xe?"xxs":"sm",align:"flex-end",justify:"flex-end",flex:"1 1 auto ",children:[(0,n.jsxs)(l.s,{gap:xe?"xxs":"sm",align:"center",children:["picture"!==s&&(0,n.jsx)(ss,{currentInputTokens:ps,contextTokens:us,totalTokens:ms,contextWindow:ds?.contextWindow,currentMessageCount:Pe?.length??0,maxContextMessageCount:De?.maxContextMessageCount,onCompressClick:e&&!Se?()=>_e(!0):void 0,children:(0,n.jsxs)(l.s,{align:"center",gap:"2",className:"text-xs text-chatbox-tint-secondary cursor-pointer hover:text-chatbox-tint-primary transition-colors",children:[(0,n.jsx)(be.n,{icon:k.A,size:14}),(0,n.jsxs)(m.E,{span:!0,size:"xs",className:"whitespace-nowrap",children:[(0,P.ZV)(ms),!xe&&ds?.contextWindow&&` / ${(0,P.ZV)(ds.contextWindow)}`]})]})}),(0,n.jsx)(p.m,{label:(0,n.jsxs)(l.s,{align:"center",c:"white",gap:"xxs",children:[(0,n.jsx)(be.n,{icon:C.A,size:12,className:"text-inherit"}),(0,n.jsx)(m.E,{span:!0,size:"xxs",c:"white",children:me("Please select a model")})]}),color:"dark",opened:xs,withArrow:!0,children:"picture"===s?(0,n.jsx)(ve,{onSelect:I,children:(0,n.jsxs)("span",{className:"flex items-center text-sm cursor-pointer bg-transparent h-6",children:[ls.find((e=>e.id===z?.provider))?.name||z?.provider||me("Select Model"),(0,n.jsx)(be.n,{icon:v.A,size:16,className:"opacity-50"})]})}):(0,n.jsx)(Le.Ay,{onSelect:I,selectedProviderId:z?.provider,selectedModelId:z?.modelId,position:"top-end",transitionProps:{transition:"fade-up",duration:200},children:(0,n.jsxs)(l.s,{gap:"xxs",px:xe?0:"xs",align:"center",className:(0,J.cn)("cursor-pointer"),children:[!!z&&(0,n.jsx)(Ae,{size:xe?20:24,provider:z.provider}),(0,n.jsx)(m.E,{size:xe?"xs":"sm",className:"line-clamp-1",children:cs}),(0,n.jsx)(be.n,{icon:v.A,size:20,className:"flex-[0_0_auto] text-chatbox-tint-tertiary"})]})})})]}),(0,n.jsx)(d.M,{disabled:(as||os||Oe)&&!t,radius:18,size:xe?28:36,onClick:t?T:()=>vs(),className:(0,J.cn)((as||os||Oe)&&!t&&"!text-white !bg-chatbox-background-tertiary"),children:t?(0,n.jsx)(be.n,{icon:S.A,size:20}):(0,n.jsx)(be.n,{icon:k.A,size:20})})]})]})]}),Ee&&(0,n.jsx)(ye,{opened:qe,onClose:()=>_e(!1),session:Ee})]})})),is=({onImageUploadClick:e,onFileUploadClick:s,handleAttachLink:t,t:i,size:r=24,iconSize:o=20})=>{const a=(0,O.L0)();return(0,n.jsxs)(u.W,{shadow:"md",trigger:a?"click":"hover",position:"top-start",openDelay:100,closeDelay:100,keepMounted:!0,transitionProps:{transition:"pop",duration:200},children:[(0,n.jsx)(u.W.Target,{children:(0,n.jsx)(d.M,{size:20===r?void 0:`${r}px`,variant:20===r?"transparent":"subtle",color:"chatbox-secondary",...20===r?{w:20,h:20,miw:20,mih:20,bd:"none"}:{},children:(0,n.jsx)(be.n,{icon:z.A,strokeWidth:1.8,size:o})})}),(0,n.jsxs)(u.W.Dropdown,{children:[(0,n.jsx)(u.W.Item,{leftSection:(0,n.jsx)(be.n,{icon:M.A,size:16}),onClick:e,children:i("Attach Image")}),(0,n.jsx)(u.W.Item,{leftSection:(0,n.jsx)(be.n,{icon:I.A,size:16}),onClick:s,children:i("Select File")}),(0,n.jsx)(u.W.Item,{leftSection:(0,n.jsx)(be.n,{icon:A.A,size:16}),onClick:t,children:i("Attach Link")})]})]})},rs=N.memo(ns)},25780:(e,s,t)=>{t.d(s,{o:()=>d});var n=t(74848),i=t(12335),r=t(48324),o=t(9203),a=t(96540),l=t(74791),c=t(7824);const d=(0,a.forwardRef)((({onClick:e,tooltipLabel:s,disabled:t=!1,isMobile:a=!1,size:d,variant:p},u)=>{const m=a?{...c.Y,color:"chatbox-secondary"}:{...c.y,size:d||c.y.size,variant:p||c.y.variant};return(0,n.jsx)(i.m,{label:s,withArrow:!0,position:"top-start",children:(0,n.jsx)(r.M,{ref:u,...m,disabled:t||!e,onClick:e,children:(0,n.jsx)(l.n,{icon:o.A,size:22,strokeWidth:1.8})})})}));d.displayName="SessionSettingsButton"},51154:(e,s,t)=>{t.d(s,{u:()=>c});var n=t(74848),i=t(48324),r=t(56695),o=t(96540),a=t(74791),l=t(7824);const c=(0,o.forwardRef)((({active:e,onClick:s,isMobile:t=!1,size:o,variant:c},d)=>{const p=t?{...l.Y,color:e?"chatbox-brand":"chatbox-secondary"}:{...l.y,size:o||l.y.size,variant:c||l.y.variant,color:e?"chatbox-brand":"chatbox-secondary"};return(0,n.jsx)(i.M,{ref:d,...p,onClick:s,children:(0,n.jsx)(a.n,{icon:r.A,size:22,strokeWidth:1.8})})}));c.displayName="WebBrowsingButton"},7824:(e,s,t)=>{t.d(s,{Y:()=>n,y:()=>i});const n={variant:"transparent",w:20,h:20,miw:20,mih:20,bd:"none"},i={size:"24px",variant:"subtle",color:"chatbox-secondary"}}}]);
//# sourceMappingURL=6389.616196a43b792c1d39cc.js.map