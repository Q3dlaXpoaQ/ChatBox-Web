{"version":3,"file":"assets/js/6389.616196a43b792c1d39cc.js","mappings":"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","sources":["webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/ImageUploadButton.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/ImageUploadInput.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/hooks/useInputBoxHistory.ts","webpack://xyz.chatboxapp.ce/./src/renderer/hooks/useMessageInput.ts","webpack://xyz.chatboxapp.ce/./src/renderer/hooks/useTokenCount.ts","webpack://xyz.chatboxapp.ce/./src/renderer/components/CompressionModal.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/ImageModelSelect.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/icons/ProviderImageIcon.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/knowledge-base/KnowledgeBaseMenu.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/mcp/MCPStatus.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/mcp/MCPMenu.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/preprocessState.ts","webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/TokenCountMenu.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/InputBox.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/hooks/useKnowledgeBase.ts","webpack://xyz.chatboxapp.ce/./src/renderer/utils/index.ts","webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/SessionSettingsButton.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/WebBrowsingButton.tsx","webpack://xyz.chatboxapp.ce/./src/renderer/components/InputBox/actionIconStyles.ts"],"sourcesContent":["import { ActionIcon, Tooltip } from '@mantine/core'\nimport { IconPhoto } from '@tabler/icons-react'\nimport { forwardRef } from 'react'\nimport { desktopActionIconProps, mobileActionIconProps } from './actionIconStyles'\n\ninterface ImageUploadButtonProps {\n  onClick: () => void\n  tooltipLabel: string\n  isMobile?: boolean\n  size?: string | number\n  variant?: string\n}\n\nexport const ImageUploadButton = forwardRef<HTMLButtonElement, ImageUploadButtonProps>(\n  ({ onClick, tooltipLabel, isMobile = false, size, variant }, ref) => {\n    const actionIconProps = isMobile\n      ? { ...mobileActionIconProps, color: 'chatbox-secondary' }\n      : {\n          ...desktopActionIconProps,\n          size: size || desktopActionIconProps.size,\n          variant: variant || desktopActionIconProps.variant,\n        }\n\n    return (\n      <Tooltip label={tooltipLabel} withArrow position=\"top-start\">\n        <ActionIcon ref={ref} {...actionIconProps} onClick={onClick}>\n          <IconPhoto strokeWidth={1.8} />\n        </ActionIcon>\n      </Tooltip>\n    )\n  }\n)\n\nImageUploadButton.displayName = 'ImageUploadButton'\n","import type React from 'react'\nimport { forwardRef } from 'react'\n\ninterface ImageUploadInputProps {\n  onChange: (event: React.ChangeEvent<HTMLInputElement>) => void\n  accept?: string\n  multiple?: boolean\n  className?: string\n  style?: React.CSSProperties\n}\n\nexport const ImageUploadInput = forwardRef<HTMLInputElement, ImageUploadInputProps>(\n  ({ onChange, accept = 'image/png, image/jpeg', multiple = true, className = 'hidden', style }, ref) => {\n    return (\n      <input\n        ref={ref}\n        type=\"file\"\n        accept={accept}\n        multiple={multiple}\n        onChange={onChange}\n        className={className}\n        style={style || { display: 'none' }}\n      />\n    )\n  }\n)\n\nImageUploadInput.displayName = 'ImageUploadInput'\n","import { useAtom } from 'jotai'\nimport { atomWithStorage } from 'jotai/utils'\nimport { e } from 'ofetch/dist/error-04138797'\nimport { useState } from 'react'\n\nconst MAX_HISTORY_LENGTH = 20\nconst inputBoxHistoryAtom = atomWithStorage<string[]>('input-box-history', [])\n\nconst useInputBoxHistory = () => {\n  const [currentHistoryIndex, setCurrentHistoryIndex] = useState(-1)\n  const [inputBoxHistory, setInputBoxHistory] = useAtom(inputBoxHistoryAtom)\n\n  const addInputBoxHistory = (input: string) => {\n    setInputBoxHistory([input, ...inputBoxHistory.filter((h) => h !== input)].slice(0, MAX_HISTORY_LENGTH))\n  }\n\n  const clearInputBoxHistory = () => {\n    setInputBoxHistory([])\n  }\n\n  const getPreviousHistoryInput = () => {\n    if (currentHistoryIndex < inputBoxHistory.length - 1) {\n      // 如果当前索引小于历史记录长度减1，说明有历史记录可供前进\n      const previousIndex = currentHistoryIndex + 1\n      setCurrentHistoryIndex(previousIndex)\n      return inputBoxHistory[previousIndex]\n    }\n  }\n\n  const getNextHistoryInput = () => {\n    if (currentHistoryIndex > 0) {\n      // 如果当前索引大于0，说明有历史记录可供回退\n      const nextIndex = currentHistoryIndex - 1\n      setCurrentHistoryIndex(nextIndex)\n      return inputBoxHistory[nextIndex]\n    }\n  }\n\n  const resetHistoryIndex = () => {\n    setCurrentHistoryIndex(-1)\n  }\n\n  return {\n    inputBoxHistory,\n    addInputBoxHistory,\n    clearInputBoxHistory,\n    getPreviousHistoryInput,\n    getNextHistoryInput,\n    resetHistoryIndex,\n  }\n}\n\nexport default useInputBoxHistory\n","import { useAtomValue } from 'jotai'\nimport { debounce } from 'lodash'\nimport { type Dispatch, type SetStateAction, useCallback, useEffect, useMemo, useRef, useState } from 'react'\nimport { currentSessionIdAtom } from '@/stores/atoms/sessionAtoms'\n\nconst DEFAULT_OPTIONS = { saveDraft: true, timeout: 300, isNewSession: false }\ntype Options = typeof DEFAULT_OPTIONS\nexport function useMessageInput(initialMessage = '', _options: Partial<Options> = {}) {\n  const options = {\n    ...DEFAULT_OPTIONS,\n    ..._options,\n  }\n  const [messageInput, _setMessageInput] = useState<string>(initialMessage)\n  const currentSessionId = useAtomValue(currentSessionIdAtom)\n\n  const draftRef = useRef<string>(initialMessage)\n\n  const draftStorageKey = useMemo(() => {\n    return options.isNewSession ? 'new-chat' : `draft-${currentSessionId}`\n  }, [currentSessionId, options.isNewSession])\n\n  const restoreDraft = useCallback(() => {\n    const draft = localStorage.getItem(draftStorageKey)\n    if (!draft) return\n    _setMessageInput(draft)\n    draftRef.current = draft\n  }, [draftStorageKey])\n\n  const _debouncedStoreDraft = useMemo(\n    () =>\n      debounce((message: string) => {\n        localStorage.setItem(draftStorageKey, message)\n      }, options.timeout),\n    [draftStorageKey, options.timeout]\n  )\n\n  const storeDraft = useCallback(\n    (newMessage: SetStateAction<string>) => {\n      let message: string\n      if (typeof newMessage === 'string') {\n        message = newMessage\n      } else {\n        // if setMessageInput is called with callback function\n        message = newMessage(draftRef.current)\n      }\n\n      // should update draftRef outside _debouncedStoreDraft\n      draftRef.current = message\n      _debouncedStoreDraft(message)\n    },\n    [_debouncedStoreDraft]\n  )\n\n  const setMessageInput: Dispatch<SetStateAction<string>> = useCallback(\n    (newMessage) => {\n      _setMessageInput(newMessage)\n      storeDraft(newMessage)\n    },\n    [storeDraft]\n  )\n\n  const clearDraft = useCallback(() => {\n    _setMessageInput('')\n    draftRef.current = ''\n    localStorage.removeItem(draftStorageKey)\n    _debouncedStoreDraft.cancel()\n  }, [draftStorageKey, _debouncedStoreDraft])\n\n  useEffect(() => {\n    if (options.saveDraft) {\n      restoreDraft()\n    }\n  }, [restoreDraft, options.saveDraft])\n\n  return {\n    messageInput,\n    setMessageInput,\n    clearDraft,\n    storeDraft,\n    restoreDraft,\n  }\n}\n","import { useDebouncedValue } from '@mantine/hooks'\nimport { type UseQueryOptions, useQueries } from '@tanstack/react-query'\nimport { sum } from 'lodash'\nimport { useEffect, useMemo, useState } from 'react'\nimport { estimateTokensFromMessages, isDeepSeekModel } from '@/packages/token'\nimport queryClient from '@/stores/queryClient'\nimport { type Message, type MessageTokenCountResult, TOKEN_CACHE_KEYS } from '../../shared/types'\nimport * as chatStore from '../stores/chatStore'\n\nasync function saveMessageTokenCount(sessionId: string, calcResults: MessageTokenCountResult[]) {\n  // mark queries result as reused when saved to storage, prevent re-calculation\n  const messageIds = calcResults.map((mu) => mu.id)\n  queryClient.setQueriesData(\n    {\n      predicate: (query) =>\n        query.queryKey[0] === 'message-token-count' && messageIds.includes(String(query.queryKey[1])),\n    },\n    (data: MessageTokenCountResult) => {\n      return { ...data, reused: true }\n    }\n  )\n\n  // save calculated token count to storage\n  await chatStore.updateMessages(sessionId, (messages) => {\n    if (!messages) {\n      throw new Error('messages is null')\n    }\n    return messages.map((m) => {\n      const update = calcResults.find((mu) => mu.id === m.id)\n      if (update) {\n        return {\n          ...m,\n          tokenCountMap: update.tokenCountMap,\n        }\n      }\n      return m\n    })\n  })\n}\n\n// get estimated token count for a list of context messages, save to message storage for later reuse\nexport function useMessagesTokenCountQuery(\n  sessionId: string | null,\n  messageIds: string[] | null,\n  model?: { provider: string; modelId: string }\n) {\n  const { session, refetch } = chatStore.useSession(sessionId)\n\n  const results = useQueries({\n    queries:\n      messageIds?.map((id) => {\n        return {\n          queryKey: ['message-token-count', id],\n          queryFn: () => {\n            if (!session) {\n              return null\n            }\n            // only calculate token count for messages in current session\n            const m = session.messages.find((msg) => msg.id === id)\n            if (!m) {\n              return null\n            }\n            if (m.tokenCountMap) {\n              return { id: m.id, tokenCountMap: m.tokenCountMap, reused: true }\n            } else {\n              console.debug('useTokenCount', 'count token for message', m.id)\n              return {\n                id: m.id,\n                tokenCountMap: {\n                  deepseek: estimateTokensFromMessages([m], 'input', { modelId: 'deepseek', provider: '' }),\n                  default: estimateTokensFromMessages([m], 'input'),\n                },\n                reused: false,\n              }\n            }\n          },\n          enabled: !!sessionId && !!messageIds,\n          // currently this cache is not updated after message content edited\n          staleTime: 30 * 1000, // 30 seconds\n        } satisfies UseQueryOptions\n      }) || [],\n  })\n\n  useEffect(() => {\n    if (!sessionId || sessionId === 'new') {\n      return\n    }\n    // need to write to storage\n    const newCalcResults = results\n      .filter((result) => result.data?.tokenCountMap && !result.data?.reused)\n      .map((m) => m.data!)\n\n    if (newCalcResults.length === 0) {\n      return\n    }\n    // save to storage and refetch session, prevent queryFn accessing stale session data to avoid infinite loop\n    void saveMessageTokenCount(sessionId, newCalcResults).then(() => refetch())\n  }, [results, sessionId, refetch])\n\n  const tokenCount = useMemo(() => {\n    return sum(\n      results.map((r) => {\n        if (isDeepSeekModel(model)) {\n          return r.data?.tokenCountMap?.[TOKEN_CACHE_KEYS.deepseek] ?? 0\n        }\n        return r.data?.tokenCountMap?.[TOKEN_CACHE_KEYS.default] ?? 0\n      })\n    )\n  }, [results, model])\n\n  return tokenCount\n}\n\nexport function useTokenCount(\n  sessionId: string | null,\n  constructedMessage: Message | undefined,\n  messageIds: string[] | null,\n  model?: { provider: string; modelId: string }\n) {\n  const [currentInputTokens, setCurrentInputTokens] = useState(0)\n\n  const contextTokens = useMessagesTokenCountQuery(sessionId, messageIds, model)\n\n  const [debouncedConstructedMessage] = useDebouncedValue(constructedMessage, 300)\n\n  useEffect(() => {\n    if (!debouncedConstructedMessage) {\n      setCurrentInputTokens(0)\n      return\n    } else {\n      console.debug('useTokenCount', 'calculate current input tokens')\n      setCurrentInputTokens(\n        estimateTokensFromMessages([debouncedConstructedMessage], 'input', {\n          modelId: model?.modelId || '',\n          provider: model?.provider || '',\n        })\n      )\n    }\n  }, [debouncedConstructedMessage, model?.modelId, model?.provider])\n\n  return {\n    currentInputTokens,\n    contextTokens,\n    totalTokens: currentInputTokens + contextTokens,\n  }\n}\n","import { Button, Flex, Stack, Text } from '@mantine/core'\nimport { IconCircleCheck } from '@tabler/icons-react'\nimport { useEffect, useMemo, useRef, useState } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { getModel } from 'src/shared/models'\nimport type { OnResultChangeWithCancel } from 'src/shared/models/types'\nimport type { Session } from 'src/shared/types/session'\nimport { createModelDependencies } from '@/adapters'\nimport { languageNameMap } from '@/i18n/locales'\nimport { streamText } from '@/packages/model-calls'\nimport * as promptFormat from '@/packages/prompts'\nimport { useSessionSettings } from '@/stores/chatStore'\nimport { compressAndCreateThread } from '@/stores/sessionActions'\nimport { settingsStore } from '@/stores/settingsStore'\nimport { Modal } from './Overlay'\nimport { ScalableIcon } from './ScalableIcon'\n\ninterface CompressionModalProps {\n  opened: boolean\n  onClose: () => void\n  session: Session\n}\n\nexport function CompressionModal({ opened, onClose, session }: CompressionModalProps) {\n  const { t } = useTranslation()\n  const [isCompressing, setIsCompressing] = useState(false)\n  const [summary, setSummary] = useState('')\n  const [error, setError] = useState<string | null>(null)\n  const [isCompleted, setIsCompleted] = useState(false)\n  const { sessionSettings: settings } = useSessionSettings(session.id)\n\n  const lastThreeLines = useMemo(() => {\n    const lines = summary.split('\\n').filter((line) => line.trim() !== '')\n    return lines.slice(-3).join('\\n')\n  }, [summary])\n\n  const abortControllerRef = useRef<AbortController | null>(null)\n\n  const handleConfirm = async () => {\n    setIsCompressing(true)\n    setError(null)\n    setSummary('')\n\n    try {\n      if (!settings) {\n        return null\n      }\n\n      const globalSettings = settingsStore.getState().getSettings()\n      if (!session) {\n        return null\n      }\n\n      const dependencies = await createModelDependencies()\n      const model = getModel(settings, globalSettings, { uuid: '' }, dependencies)\n\n      // Create summary prompt\n      const messages = session.messages.slice(-(settings.maxContextMessageCount || 0))\n      const promptMsgs = promptFormat.summarizeConversation(messages, languageNameMap[globalSettings.language])\n\n      // Stream the summary\n      let fullSummary = ''\n      const onResultChange: OnResultChangeWithCancel = (result) => {\n        const text =\n          result.contentParts\n            ?.filter((part) => part.type === 'text')\n            .map((part) => part.text)\n            .join('') || ''\n        fullSummary = text\n        setSummary(text)\n      }\n      const abortController = new AbortController()\n      abortControllerRef.current = abortController\n      await streamText(\n        model,\n        {\n          sessionId: session.id,\n          messages: promptMsgs,\n          onResultChangeWithCancel: onResultChange,\n          providerOptions: settings.providerOptions,\n        },\n        abortController.signal\n      )\n\n      if (abortController.signal.aborted) {\n        return\n      }\n\n      // After summary is complete, create new thread with compressed context\n      await compressAndCreateThread(session.id, fullSummary)\n\n      // Show completion message and delay closing\n      setIsCompleted(true)\n      setIsCompressing(false)\n\n      // Delay closing the modal to show completion message\n      setTimeout(() => {\n        onClose()\n      }, 1500)\n    } catch (err) {\n      console.error('Compression failed:', err)\n      setError(err instanceof Error ? err.message : 'Compression failed')\n    } finally {\n      setIsCompressing(false)\n      abortControllerRef.current?.abort()\n      abortControllerRef.current = null\n    }\n  }\n\n  useEffect(() => {\n    if (!opened) {\n      // Reset state when modal closes\n      setIsCompressing(false)\n      setSummary('')\n      setError(null)\n      setIsCompleted(false)\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort()\n        abortControllerRef.current = null\n      }\n    }\n  }, [opened])\n\n  return (\n    <Modal\n      opened={opened}\n      onClose={\n        !isCompressing && !isCompleted\n          ? onClose\n          : () => {\n              abortControllerRef.current?.abort()\n              abortControllerRef.current = null\n              onClose()\n            }\n      }\n      title={t('Compress Conversation')}\n      centered\n      size=\"md\"\n    >\n      <Stack gap=\"md\">\n        {!isCompressing && !isCompleted && !error && (\n          <>\n            <Text>\n              {t(\n                'This will summarize the current conversation and start a new thread with the compressed context. Continue?'\n              )}\n            </Text>\n            <Flex gap=\"sm\" justify=\"flex-end\">\n              <Button variant=\"subtle\" onClick={onClose}>\n                {t('Cancel')}\n              </Button>\n              <Button onClick={handleConfirm}>{t('Confirm')}</Button>\n            </Flex>\n          </>\n        )}\n\n        {isCompressing && (\n          <Text\n            size=\"sm\"\n            style={{\n              whiteSpace: 'pre-wrap',\n              height: '60px',\n              overflow: 'hidden',\n              lineHeight: '20px',\n            }}\n          >\n            {lastThreeLines || t('Generating summary...')}\n          </Text>\n        )}\n\n        {isCompleted && (\n          <>\n            <Flex align=\"center\" gap=\"xs\" mb=\"sm\">\n              <ScalableIcon icon={IconCircleCheck} size={20} color=\"var(--chatbox-tint-success)\" />\n              <Text size=\"sm\" c=\"green\" fw={500}>\n                {t('Compression completed successfully!')}\n              </Text>\n            </Flex>\n            <Text size=\"xs\" c=\"dimmed\" mt=\"xs\">\n              {t('Starting new thread...')}\n            </Text>\n          </>\n        )}\n\n        {error && (\n          <>\n            <Text c=\"red\">{error}</Text>\n            <Flex gap=\"sm\" justify=\"flex-end\">\n              <Button onClick={onClose}>{t('Close')}</Button>\n            </Flex>\n          </>\n        )}\n      </Stack>\n    </Modal>\n  )\n}\n","import { useProviders } from '@/hooks/useProviders'\nimport { Combobox, ComboboxProps, useCombobox } from '@mantine/core'\nimport { FC, PropsWithChildren } from 'react'\nimport { ModelProvider, ModelProviderEnum } from 'src/shared/types'\n\nexport type ImageModelSelectProps = PropsWithChildren<\n  {\n    onSelect?: (provider: ModelProvider, model: string) => void\n  } & ComboboxProps\n>\n\nexport const ImageModelSelect: FC<ImageModelSelectProps> = ({ onSelect, children, ...comboboxProps }) => {\n  const { providers } = useProviders()\n\n  const avaliableProviders = providers.filter((p) => [ModelProviderEnum.OpenAI, ModelProviderEnum.Azure, ''].includes(p.id))\n\n  const combobox = useCombobox({\n    onDropdownClose: () => {\n      combobox.resetSelectedOption()\n      combobox.focusTarget()\n    },\n  })\n\n  const handleOptionSubmit = (val: string) => {\n    onSelect?.(val as any, 'DALL-E-3')\n    combobox.closeDropdown()\n  }\n\n  return (\n    <Combobox\n      store={combobox}\n      width={260}\n      position=\"top\"\n      withinPortal={true}\n      {...comboboxProps}\n      onOptionSubmit={handleOptionSubmit}\n    >\n      <Combobox.Target targetType=\"button\">\n        <button onClick={() => combobox.toggleDropdown()} className=\"border-none bg-transparent p-0 flex\">\n          {children}\n        </button>\n      </Combobox.Target>\n\n      <Combobox.Dropdown>\n        <Combobox.Options mah={500} style={{ overflowY: 'auto' }}>\n          {/* Chatbox AI 作为默认选项 */}\n          <Combobox.Option value={ModelProviderEnum.ChatboxAI} c=\"chatbox-primary\">\n            Chatbox AI\n          </Combobox.Option>\n          {avaliableProviders.map((p) => (\n            <Combobox.Option key={p.id} value={p.id} c=\"chatbox-primary\">\n              {p.name} (DALL-E-3)\n            </Combobox.Option>\n          ))}\n        </Combobox.Options>\n      </Combobox.Dropdown>\n    </Combobox>\n  )\n}\n\nexport default ImageModelSelect\n","import { Image } from '@mantine/core'\nimport type { ModelProvider } from 'src/shared/types'\nimport { useProviders } from '@/hooks/useProviders'\nimport CustomProviderIcon from '../CustomProviderIcon'\n\nconst iconContext = (require as any).context('../../static/icons/providers', false, /\\.png$/)\nconst icons: { name: string; src: string }[] = iconContext.keys().map((key: string) => ({\n  name: key.replace('./', '').replace('.png', ''), // 获取图片名称\n  src: iconContext(key), // 获取图片路径\n}))\n\nexport default function ProviderImageIcon(props: {\n  className?: string\n  size?: number\n  provider: ModelProvider | string\n  providerName?: string\n}) {\n  const { className, size = 24, provider, providerName } = props\n\n  const {providers} = useProviders()\n  const providerInfo = providers.find((p) => p.id === provider)\n  \n  if(providerInfo?.isCustom){\n    return providerInfo.iconUrl ? (\n      <Image w={size} h={size} src={providerInfo.iconUrl} alt={providerInfo.name} />\n    ) : (\n      <CustomProviderIcon providerId={providerInfo.id} providerName={providerInfo.name} size={size} />\n    )\n  }\n\n  const iconSrc = icons.find((icon) => icon.name === provider)?.src\n\n  return iconSrc ? (\n    <Image w={size} h={size} src={iconSrc} className={className} alt={`${providerName || provider} image icon`} />\n  ) : providerName ? (\n    <CustomProviderIcon providerId={provider} providerName={providerName} size={size} />\n  ) : null\n}\n","import { Button, Flex, Group, Menu, Text } from '@mantine/core'\nimport { IconCheck, IconFile, IconSettings2 } from '@tabler/icons-react'\nimport { Link } from '@tanstack/react-router'\nimport { PlusIcon } from 'lucide-react'\nimport type { FC } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport type { KnowledgeBase } from 'src/shared/types'\nimport { useKnowledgeBases } from '@/hooks/knowledge-base'\n\ntype Props = {\n  currentKnowledgeBaseId?: number\n  children?: React.ReactNode\n  onSelect?: (kb: KnowledgeBase | null) => void\n  opened?: boolean\n  setOpened?: (opened: boolean) => void\n}\n\nconst KnowledgeBaseMenu: FC<Props> = (props) => {\n  const { data: knowledgeBases } = useKnowledgeBases()\n  const { t } = useTranslation()\n\n  return (\n    <Menu\n      position=\"top\"\n      shadow=\"md\"\n      keepMounted\n      // 使用动画延迟消失，保证点击后能看到选中状态\n      transitionProps={{\n        transition: 'fade-up',\n        duration: 300,\n      }}\n    >\n      <Menu.Target>{props.children}</Menu.Target>\n      <Menu.Dropdown className=\"min-w-40\">\n        <Flex justify=\"space-between\">\n          <Menu.Label fw={600}>{t('Knowledge Base')}</Menu.Label>\n          <Menu.Label>\n            <Link to=\"/settings/knowledge-base\">\n              <IconSettings2 size={16} color=\"var(--chatbox-tint-tertiary)\" />\n            </Link>\n          </Menu.Label>\n        </Flex>\n        {knowledgeBases?.map((kb) => (\n          <Menu.Item key={kb.id} onClick={() => props.onSelect?.(kb)}>\n            <Flex justify=\"space-between\" align=\"center\" gap=\"xs\">\n              <Flex gap=\"xs\" align=\"center\">\n                <IconFile size={14} />\n                <Text c={kb.id === props.currentKnowledgeBaseId ? 'chatbox-brand' : ''}>{kb.name}</Text>\n              </Flex>\n              {kb.id === props.currentKnowledgeBaseId && <IconCheck size={14} color=\"var(--chatbox-tint-brand)\" />}\n            </Flex>\n          </Menu.Item>\n        ))}\n        {knowledgeBases?.length === 0 && (\n          <Group justify=\"center\" className=\"w-full\">\n            <Link to=\"/settings/knowledge-base\" className=\"w-full\">\n              <Button size=\"xs\" variant=\"light\" w=\"100%\">\n                <PlusIcon size={14} className=\"mr-1\" />\n                {t('Create')}\n              </Button>\n            </Link>\n          </Group>\n        )}\n      </Menu.Dropdown>\n    </Menu>\n  )\n}\n\nexport default KnowledgeBaseMenu\n","import { cn } from '@/lib/utils'\nimport { MCPServerStatus } from '@/packages/mcp/types'\nimport { Tooltip } from '@mantine/core'\nimport { FC } from 'react'\n\nconst MCPStatus: FC<{ status: MCPServerStatus | null }> = ({ status }) => {\n  if (status?.error) {\n    return (\n      <Tooltip label={status.error} withArrow color=\"chatbox-error\" multiline w={260}>\n        <div className=\"rounded-full size-[6.6px] bg-red-500\" />\n      </Tooltip>\n    )\n  }\n  return (\n    <div\n      className={cn(\n        'rounded-full size-[6.6px]',\n        (!status || status?.state === 'idle') && 'bg-gray-500',\n        status?.state === 'running' && 'bg-green-500',\n        status?.state === 'starting' && 'bg-blue-500 animate-pulse',\n        status?.state === 'stopping' && 'bg-yellow-500 animate-pulse',\n        status?.error && 'bg-red-500'\n      )}\n    />\n  )\n}\n\nexport default MCPStatus\n","import { ActionIcon, Button, Flex, Group, Menu, Switch } from '@mantine/core'\nimport { IconSettings2 } from '@tabler/icons-react'\nimport { Link } from '@tanstack/react-router'\nimport { type FC, type ReactNode, useState } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { useMCPServerStatus, useToggleMCPServer } from '@/hooks/mcp'\nimport { navigateToSettings } from '@/modals/Settings'\nimport { BUILTIN_MCP_SERVERS } from '@/packages/mcp/builtin'\nimport { useAutoValidate } from '@/stores/premiumActions'\nimport { useMcpSettings } from '@/stores/settingsStore'\nimport { ScalableIcon } from '../ScalableIcon'\nimport MCPStatus from './MCPStatus'\n\ninterface ServerItem {\n  id: string\n  name: string\n  enabled: boolean\n}\n\nconst ServerItem: FC<{\n  item: ServerItem\n  onEnabledChange: (id: string, enabled: boolean) => void\n}> = ({ item, onEnabledChange }) => {\n  const status = useMCPServerStatus(item.id)\n  return (\n    <Menu.Item\n      c=\"chatbox-primary\"\n      leftSection={<MCPStatus status={status} />}\n      rightSection={\n        <Switch\n          checked={item.enabled}\n          size=\"xs\"\n          disabled={status?.state === 'starting' || status?.state === 'stopping'}\n          onChange={(e) => onEnabledChange(item.id, e.currentTarget.checked)}\n        />\n      }\n    >\n      {item.name}\n    </Menu.Item>\n  )\n}\n\nconst MCPMenu: FC<{ children: (enabledTools: number) => ReactNode }> = ({ children }) => {\n  const { t } = useTranslation()\n  const mcp = useMcpSettings()\n  const isPremium = useAutoValidate()\n  const onEnabledChange = useToggleMCPServer()\n  const enabledToolsCount = mcp.servers.filter((s) => s.enabled).length + mcp.enabledBuiltinServers.length\n  const [opened, setOpened] = useState(false)\n  return (\n    <Menu\n      trigger=\"hover\"\n      openDelay={100}\n      closeDelay={100}\n      opened={opened}\n      onChange={setOpened}\n      shadow=\"md\"\n      withArrow\n      width={240}\n      closeOnItemClick={false}\n      position=\"top-start\"\n      transitionProps={{\n        transition: 'pop',\n        duration: 200,\n      }}\n    >\n      <Menu.Target>{children(enabledToolsCount)}</Menu.Target>\n      <Menu.Dropdown>\n        <Flex justify=\"space-between\" align=\"center\">\n          <Menu.Label fw={600}>MCP</Menu.Label>\n          <Menu.Label>\n            <ActionIcon\n              variant=\"subtle\"\n              size={20}\n              onClick={() => {\n                setOpened(false)\n                navigateToSettings('/mcp')\n              }}\n            >\n              <ScalableIcon icon={IconSettings2} size={16} color=\"var(--chatbox-tint-tertiary)\" />\n            </ActionIcon>\n          </Menu.Label>\n        </Flex>\n        {isPremium && (\n          <>\n            {BUILTIN_MCP_SERVERS.map((server) => (\n              <ServerItem\n                key={server.id}\n                item={{\n                  id: server.id,\n                  name: server.name,\n                  enabled: mcp.enabledBuiltinServers.includes(server.id),\n                }}\n                onEnabledChange={onEnabledChange}\n              />\n            ))}\n            <Menu.Divider />\n          </>\n        )}\n        {mcp.servers.map((server) => (\n          <ServerItem key={server.id} item={server} onEnabledChange={onEnabledChange} />\n        ))}\n        {!mcp.servers.length && !mcp.enabledBuiltinServers.length && (\n          <Group justify=\"center\">\n            <Link to=\"/settings/mcp\">\n              <Button size=\"xs\" my={12} variant=\"outline\">\n                {t('Add your first MCP server')}\n              </Button>\n            </Link>\n          </Group>\n        )}\n      </Menu.Dropdown>\n    </Menu>\n  )\n}\n\nexport default MCPMenu\n","import { StorageKeyGenerator } from '@/storage/StoreStorage'\nimport type { PreConstructedMessageState, PreprocessedFile, PreprocessedLink } from '../../types/input-box'\nexport type { PreConstructedMessageState }\n\n// ----- Link helpers -----\n\nexport function markLinkProcessing(prev: PreConstructedMessageState, url: string): PreConstructedMessageState {\n  const key = StorageKeyGenerator.linkUniqKey(url)\n  return {\n    ...prev,\n    preprocessingStatus: {\n      ...prev.preprocessingStatus,\n      links: {\n        ...prev.preprocessingStatus.links,\n        [key]: 'processing',\n      },\n    },\n  }\n}\n\nexport function storeLinkPromise(\n  prev: PreConstructedMessageState,\n  url: string,\n  promise: Promise<unknown>\n): PreConstructedMessageState {\n  const key = StorageKeyGenerator.linkUniqKey(url)\n  const newPromises = new Map(prev.preprocessingPromises.links)\n  newPromises.set(key, promise)\n  return {\n    ...prev,\n    preprocessingPromises: {\n      ...prev.preprocessingPromises,\n      links: newPromises,\n    },\n  }\n}\n\nexport function onLinkProcessed(\n  prev: PreConstructedMessageState,\n  url: string,\n  item: PreprocessedLink,\n  max: number = 6\n): PreConstructedMessageState {\n  const key = StorageKeyGenerator.linkUniqKey(url)\n  const newPromises = new Map(prev.preprocessingPromises.links)\n  newPromises.delete(key)\n\n  const nextLinks = [...prev.preprocessedLinks.filter((l) => l.url !== url), item].slice(-max)\n\n  return {\n    ...prev,\n    preprocessedLinks: nextLinks,\n    preprocessingStatus: {\n      ...prev.preprocessingStatus,\n      links: {\n        ...prev.preprocessingStatus.links,\n        [key]: item.error ? 'error' : 'completed',\n      },\n    },\n    preprocessingPromises: {\n      ...prev.preprocessingPromises,\n      links: newPromises,\n    },\n  }\n}\n\nexport function cleanupLink(prev: PreConstructedMessageState, url: string): PreConstructedMessageState {\n  const key = StorageKeyGenerator.linkUniqKey(url)\n  const newLinkPromises = new Map(prev.preprocessingPromises.links)\n  newLinkPromises.delete(key)\n\n  return {\n    ...prev,\n    preprocessedLinks: prev.preprocessedLinks.filter((l) => l.url !== url),\n    preprocessingStatus: {\n      ...prev.preprocessingStatus,\n      links: {\n        ...prev.preprocessingStatus.links,\n        [key]: undefined,\n      },\n    },\n    preprocessingPromises: {\n      ...prev.preprocessingPromises,\n      links: newLinkPromises,\n    },\n  }\n}\n\n// ----- File helpers -----\n\nexport function markFileProcessing(prev: PreConstructedMessageState, file: File): PreConstructedMessageState {\n  const key = StorageKeyGenerator.fileUniqKey(file)\n  return {\n    ...prev,\n    preprocessingStatus: {\n      ...prev.preprocessingStatus,\n      files: {\n        ...prev.preprocessingStatus.files,\n        [key]: 'processing',\n      },\n    },\n  }\n}\n\nexport function storeFilePromise(\n  prev: PreConstructedMessageState,\n  file: File,\n  promise: Promise<unknown>\n): PreConstructedMessageState {\n  const key = StorageKeyGenerator.fileUniqKey(file)\n  const newPromises = new Map(prev.preprocessingPromises.files)\n  newPromises.set(key, promise)\n  return {\n    ...prev,\n    preprocessingPromises: {\n      ...prev.preprocessingPromises,\n      files: newPromises,\n    },\n  }\n}\n\nexport function onFileProcessed(\n  prev: PreConstructedMessageState,\n  file: File,\n  item: PreprocessedFile,\n  max: number = 10\n): PreConstructedMessageState {\n  const key = StorageKeyGenerator.fileUniqKey(file)\n  const newPromises = new Map(prev.preprocessingPromises.files)\n  newPromises.delete(key)\n\n  const nextFiles = [...prev.preprocessedFiles, item].slice(-max)\n\n  return {\n    ...prev,\n    preprocessedFiles: nextFiles,\n    preprocessingStatus: {\n      ...prev.preprocessingStatus,\n      files: {\n        ...prev.preprocessingStatus.files,\n        [key]: item.error ? 'error' : 'completed',\n      },\n    },\n    preprocessingPromises: {\n      ...prev.preprocessingPromises,\n      files: newPromises,\n    },\n  }\n}\n\nexport function cleanupFile(prev: PreConstructedMessageState, file: File): PreConstructedMessageState {\n  const key = StorageKeyGenerator.fileUniqKey(file)\n  const newFilePromises = new Map(prev.preprocessingPromises.files)\n  newFilePromises.delete(key)\n\n  return {\n    ...prev,\n    preprocessedFiles: prev.preprocessedFiles.filter((f) => f.file.name !== file.name),\n    preprocessingStatus: {\n      ...prev.preprocessingStatus,\n      files: {\n        ...prev.preprocessingStatus.files,\n        [key]: undefined,\n      },\n    },\n    preprocessingPromises: {\n      ...prev.preprocessingPromises,\n      files: newFilePromises,\n    },\n  }\n}\n","import { Flex, Menu, Text } from '@mantine/core'\nimport { IconFileZip } from '@tabler/icons-react'\nimport type { FC } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { formatNumber } from 'src/shared/utils'\nimport { useIsSmallScreen } from '@/hooks/useScreenChange'\nimport { ScalableIcon } from '../ScalableIcon'\n\ntype Props = {\n  currentInputTokens: number\n  contextTokens: number\n  totalTokens: number\n  contextWindow?: number\n  currentMessageCount?: number\n  maxContextMessageCount?: number\n  children?: React.ReactNode\n  onCompressClick?: () => void\n}\n\nconst TokenCountMenu: FC<Props> = ({\n  currentInputTokens,\n  contextTokens,\n  totalTokens,\n  contextWindow,\n  currentMessageCount,\n  maxContextMessageCount,\n  children,\n  onCompressClick,\n}) => {\n  const { t } = useTranslation()\n  const isSmallScreen = useIsSmallScreen()\n\n  return (\n    <Menu\n      trigger={isSmallScreen ? 'click' : 'hover'}\n      openDelay={100}\n      closeDelay={100}\n      position=\"top\"\n      shadow=\"md\"\n      keepMounted\n      transitionProps={{\n        transition: 'pop',\n        duration: 200,\n      }}\n    >\n      <Menu.Target>{children}</Menu.Target>\n      <Menu.Dropdown className=\"min-w-56\">\n        <Menu.Label fw={600}>{t('Estimated Token Usage')}</Menu.Label>\n\n        <Menu.Item disabled style={{ cursor: 'default' }}>\n          <Flex justify=\"space-between\" align=\"center\" gap=\"xs\">\n            <Text size=\"sm\">{t('Current input')}:</Text>\n            <Text size=\"sm\" fw={500}>\n              {formatNumber(currentInputTokens)}\n            </Text>\n          </Flex>\n        </Menu.Item>\n\n        <Menu.Item disabled style={{ cursor: 'default' }}>\n          <Flex justify=\"space-between\" align=\"center\" gap=\"xs\">\n            <Text size=\"sm\">{t('Context')}:</Text>\n            <Text size=\"sm\" fw={500}>\n              {formatNumber(contextTokens)}\n            </Text>\n          </Flex>\n        </Menu.Item>\n\n        {maxContextMessageCount !== undefined && currentMessageCount !== undefined && (\n          <Menu.Item disabled style={{ cursor: 'default' }}>\n            <Flex justify=\"space-between\" align=\"center\" gap=\"xs\">\n              <Text size=\"sm\">{t('Context messages')}:</Text>\n              <Text size=\"sm\" fw={500}>\n                {maxContextMessageCount === Number.MAX_SAFE_INTEGER\n                  ? currentMessageCount\n                  : `${currentMessageCount} / ${maxContextMessageCount}`}\n              </Text>\n            </Flex>\n          </Menu.Item>\n        )}\n\n        <Menu.Divider />\n\n        <Menu.Item disabled style={{ cursor: 'default' }}>\n          <Flex justify=\"space-between\" align=\"center\" gap=\"xs\">\n            <Text size=\"sm\" fw={600}>\n              {t('Total')}:\n            </Text>\n            <Text size=\"sm\" fw={600}>\n              {formatNumber(totalTokens)}\n            </Text>\n          </Flex>\n        </Menu.Item>\n\n        {contextWindow && (\n          <Menu.Item disabled style={{ cursor: 'default' }}>\n            <Flex justify=\"space-between\" align=\"center\" gap=\"xs\">\n              <Text size=\"sm\">{t('Model limit')}:</Text>\n              <Text size=\"sm\" fw={500}>\n                {formatNumber(contextWindow)}\n              </Text>\n            </Flex>\n          </Menu.Item>\n        )}\n\n        {onCompressClick && contextTokens > 0 && (\n          <>\n            <Menu.Divider />\n            <Menu.Item\n              leftSection={<ScalableIcon icon={IconFileZip} size={16} />}\n              onClick={onCompressClick}\n              color=\"chatbox-brand\"\n            >\n              {t('Compress Conversation')}\n            </Menu.Item>\n          </>\n        )}\n      </Menu.Dropdown>\n    </Menu>\n  )\n}\n\nexport default TokenCountMenu\n","import NiceModal from '@ebay/nice-modal-react'\nimport { ActionIcon, Box, Button, Flex, Menu, Stack, Text, Textarea, Tooltip } from '@mantine/core'\nimport { useViewportSize } from '@mantine/hooks'\nimport {\n  IconAdjustmentsHorizontal,\n  IconAlertCircle,\n  IconArrowBackUp,\n  IconArrowUp,\n  IconCirclePlus,\n  IconFilePencil,\n  IconFolder,\n  IconHammer,\n  IconLink,\n  IconPhoto,\n  IconPlayerStopFilled,\n  IconPlus,\n  IconSelector,\n  IconSettings,\n  IconVocabulary,\n} from '@tabler/icons-react'\nimport { useAtom } from 'jotai'\nimport _, { pick } from 'lodash'\nimport React, { forwardRef, useCallback, useEffect, useImperativeHandle, useMemo, useRef, useState } from 'react'\nimport { useDropzone } from 'react-dropzone'\nimport { useTranslation } from 'react-i18next'\nimport { formatNumber } from 'src/shared/utils'\nimport useInputBoxHistory from '@/hooks/useInputBoxHistory'\nimport { useKnowledgeBase } from '@/hooks/useKnowledgeBase'\nimport { useMessageInput } from '@/hooks/useMessageInput'\nimport { useProviders } from '@/hooks/useProviders'\nimport { useIsSmallScreen } from '@/hooks/useScreenChange'\nimport { useTokenCount } from '@/hooks/useTokenCount'\nimport { cn } from '@/lib/utils'\nimport { trackingEvent } from '@/packages/event'\nimport * as picUtils from '@/packages/pic_utils'\nimport platform from '@/platform'\nimport storage from '@/storage'\nimport { StorageKeyGenerator } from '@/storage/StoreStorage'\nimport * as atoms from '@/stores/atoms'\nimport { useSession, useSessionSettings } from '@/stores/chatStore'\nimport { useSettingsStore } from '@/stores/settingsStore'\nimport { useUIStore } from '@/stores/uiStore'\nimport { delay } from '@/utils'\nimport { featureFlags } from '@/utils/feature-flags'\nimport { trackEvent } from '@/utils/track'\nimport {\n  type KnowledgeBase,\n  type Message,\n  ModelProviderEnum,\n  type SessionType,\n  type ShortcutSendValue,\n} from '../../../shared/types'\nimport * as dom from '../../hooks/dom'\nimport * as sessionHelpers from '../../stores/sessionHelpers'\nimport * as toastActions from '../../stores/toastActions'\nimport { FileMiniCard, ImageMiniCard, LinkMiniCard } from '../Attachments'\nimport { CompressionModal } from '../CompressionModal'\nimport ImageModelSelect from '../ImageModelSelect'\nimport ProviderImageIcon from '../icons/ProviderImageIcon'\nimport KnowledgeBaseMenu from '../knowledge-base/KnowledgeBaseMenu'\nimport ModelSelector from '../ModelSelector'\nimport MCPMenu from '../mcp/MCPMenu'\nimport { ScalableIcon } from '../ScalableIcon'\nimport { Keys } from '../Shortcut'\nimport { ImageUploadButton } from './ImageUploadButton'\nimport { ImageUploadInput } from './ImageUploadInput'\nimport {\n  cleanupFile,\n  cleanupLink,\n  markFileProcessing,\n  markLinkProcessing,\n  onFileProcessed,\n  onLinkProcessed,\n  storeFilePromise,\n  storeLinkPromise,\n} from './preprocessState'\nimport { SessionSettingsButton } from './SessionSettingsButton'\nimport TokenCountMenu from './TokenCountMenu'\nimport { WebBrowsingButton } from './WebBrowsingButton'\n\nexport type InputBoxPayload = {\n  constructedMessage: Message\n  needGenerating?: boolean\n}\n\nexport type InputBoxRef = {\n  setQuote: (quote: string) => void\n}\n\nexport type InputBoxProps = {\n  sessionId?: string\n  sessionType?: SessionType\n  generating?: boolean\n  model?: {\n    provider: string\n    modelId: string\n  }\n  fullWidth?: boolean\n  onSelectModel?(provider: string, model: string): void\n  onSubmit?(payload: InputBoxPayload): Promise<void>\n  onStopGenerating?(): boolean\n  onStartNewThread?(): boolean\n  onRollbackThread?(): boolean\n  onClickSessionSettings?(): boolean | Promise<boolean>\n}\n\nconst InputBox = forwardRef<InputBoxRef, InputBoxProps>(\n  (\n    {\n      sessionId,\n      sessionType = 'chat',\n      generating = false,\n      model,\n      fullWidth = false,\n      onSelectModel,\n      onSubmit,\n      onStopGenerating,\n      onStartNewThread,\n      onRollbackThread,\n      onClickSessionSettings,\n    },\n    ref\n  ) => {\n    const { t } = useTranslation()\n    const isSmallScreen = useIsSmallScreen()\n    const { height: viewportHeight } = useViewportSize()\n    const pasteLongTextAsAFile = useSettingsStore((state) => state.pasteLongTextAsAFile)\n    const shortcuts = useSettingsStore((state) => state.shortcuts)\n    const widthFull = useUIStore((s) => s.widthFull) || fullWidth\n\n    // Use atom as the source of truth for pictureKeys and attachments\n    const webBrowsingMode = useUIStore((s) => s.inputBoxWebBrowsingMode)\n    const setWebBrowsingMode = useUIStore((s) => s.setInputBoxWebBrowsingMode)\n\n    const currentSessionId = sessionId\n    const isNewSession = currentSessionId === 'new'\n    const { messageInput, setMessageInput, clearDraft } = useMessageInput('', { isNewSession })\n\n    // Pre-constructed message state (scoped by session)\n    const [preConstructedMessage, setPreConstructedMessage] = useAtom(\n      atoms.inputBoxPreConstructedMessageFamily(currentSessionId || 'new')\n    )\n    const pictureKeys = preConstructedMessage.pictureKeys || []\n    const attachments = preConstructedMessage.attachments || []\n\n    const { session: currentSession } = useSession(sessionId || null)\n    const { sessionSettings: currentSessionMergedSettings } = useSessionSettings(sessionId || null)\n\n    // Get current messages for token counting - will only recalculate when stable messages actually change\n    const currentContextMessageIds = useMemo(() => {\n      // Attention: do not return empty array, it will cause useTokenCount to recalculate tokens\n      if (isNewSession) return null\n      if (!currentSessionMergedSettings?.maxContextMessageCount) return null\n      if (!currentSession?.messages.length) return null\n      return currentSession.messages\n        .filter((m) => !m.generating)\n        .map((m) => m.id)\n        .slice(-(currentSessionMergedSettings.maxContextMessageCount || 0))\n    }, [isNewSession, currentSessionMergedSettings?.maxContextMessageCount, currentSession?.messages])\n\n    const { knowledgeBase, setKnowledgeBase } = useKnowledgeBase({ isNewSession })\n\n    const [showCompressionModal, setShowCompressionModal] = useState(false)\n\n    const [links, setLinks] = useAtom(atoms.inputBoxLinksFamily(currentSessionId || 'new'))\n    const [isSubmitting, setIsSubmitting] = useState(false)\n\n    useEffect(() => {\n      const constructedMessage = sessionHelpers.constructUserMessage(\n        messageInput,\n        pictureKeys,\n        preConstructedMessage.preprocessedFiles,\n        preConstructedMessage.preprocessedLinks\n      )\n      setPreConstructedMessage((prev) => ({\n        ...prev,\n        text: messageInput,\n        pictureKeys,\n        attachments,\n        links,\n        message: constructedMessage,\n      }))\n    }, [\n      messageInput,\n      pictureKeys,\n      attachments,\n      links,\n      preConstructedMessage.preprocessedFiles,\n      preConstructedMessage.preprocessedLinks,\n      setPreConstructedMessage,\n    ])\n\n    const pictureInputRef = useRef<HTMLInputElement | null>(null)\n    const fileInputRef = useRef<HTMLInputElement | null>(null)\n\n    // Check if any preprocessing is in progress\n    const isPreprocessing = useMemo(() => {\n      const hasProcessingFiles = Object.values(preConstructedMessage.preprocessingStatus.files || {}).some(\n        (status) => status === 'processing'\n      )\n      const hasProcessingLinks = Object.values(preConstructedMessage.preprocessingStatus.links || {}).some(\n        (status) => status === 'processing'\n      )\n      return hasProcessingFiles || hasProcessingLinks\n    }, [preConstructedMessage.preprocessingStatus])\n\n    const disableSubmit = useMemo(\n      () => !(messageInput.trim() || links?.length || attachments?.length || pictureKeys?.length),\n      [messageInput, links, attachments, pictureKeys]\n    )\n\n    const { providers } = useProviders()\n    const modelSelectorDisplayText = useMemo(() => {\n      if (!model) {\n        return t('Select Model')\n      }\n      const providerInfo = providers.find((p) => p.id === model.provider)\n\n      const modelInfo = (providerInfo?.models || providerInfo?.defaultSettings?.models)?.find(\n        (m) => m.modelId === model.modelId\n      )\n      return `${modelInfo?.nickname || model.modelId}`\n    }, [providers, model, t])\n\n    // Get model info for context window\n    const modelInfo = useMemo(() => {\n      if (!model) return null\n      const providerInfo = providers.find((p) => p.id === model.provider)\n      return (providerInfo?.models || providerInfo?.defaultSettings?.models)?.find((m) => m.modelId === model.modelId)\n    }, [providers, model])\n\n    // Calculate token counts - use stable messages to avoid recalculation during streaming\n    const { currentInputTokens, contextTokens, totalTokens } = useTokenCount(\n      currentSessionId || null,\n      preConstructedMessage.message,\n      currentContextMessageIds,\n      model\n    )\n\n    const [showSelectModelErrorTip, setShowSelectModelErrorTip] = useState(false)\n    useEffect(() => {\n      if (showSelectModelErrorTip) {\n        const clickEventListener = () => {\n          setShowSelectModelErrorTip(false)\n          document.removeEventListener('click', clickEventListener)\n        }\n        document.addEventListener('click', clickEventListener)\n        return () => {\n          document.removeEventListener('click', clickEventListener)\n        }\n      }\n    }, [showSelectModelErrorTip])\n\n    const [showRollbackThreadButton, setShowRollbackThreadButton] = useState(false)\n    useEffect(() => {\n      if (showRollbackThreadButton) {\n        const tid = setTimeout(() => {\n          setShowRollbackThreadButton(false)\n        }, 5000)\n        return () => {\n          clearTimeout(tid)\n        }\n      }\n    }, [showRollbackThreadButton])\n\n    const inputRef = useRef<HTMLTextAreaElement | null>(null)\n\n    useImperativeHandle(\n      ref,\n      () => ({\n        // 暂时并没有用到，还是使用了之前atom的方案\n        setQuote: (data) => {\n          setMessageInput((prev) => `${prev}\\n\\n${data}`)\n          dom.focusMessageInput()\n          dom.setMessageInputCursorToEnd()\n        },\n      }),\n      [setMessageInput]\n    )\n\n    const { addInputBoxHistory, getPreviousHistoryInput, getNextHistoryInput, resetHistoryIndex } = useInputBoxHistory()\n\n    const closeSelectModelErrorTipCb = useRef<NodeJS.Timeout>()\n    const handleSubmit = async (needGenerating = true) => {\n      if (disableSubmit || generating || isSubmitting || isPreprocessing) {\n        return\n      }\n\n      // 未选择模型时 显示error tip\n      if (!model) {\n        // 如果不延时执行，会导致error tip 立即消失\n        await delay(100)\n        if (closeSelectModelErrorTipCb.current) {\n          clearTimeout(closeSelectModelErrorTipCb.current)\n        }\n        setShowSelectModelErrorTip(true)\n        closeSelectModelErrorTipCb.current = setTimeout(() => setShowSelectModelErrorTip(false), 5000)\n        return\n      }\n\n      setIsSubmitting(true)\n      try {\n        // Use the already constructed message\n        if (!preConstructedMessage.message) {\n          console.error('No constructed message available')\n          return\n        }\n\n        const params = {\n          constructedMessage: preConstructedMessage.message,\n          needGenerating,\n        }\n\n        // 重置输入内容\n        clearDraft()\n        setLinks([])\n        // 重置预处理数据\n        setPreConstructedMessage({\n          text: '',\n          pictureKeys: [],\n          attachments: [],\n          links: [],\n          preprocessedFiles: [],\n          preprocessedLinks: [],\n          preprocessingStatus: {\n            files: {},\n            links: {},\n          },\n          preprocessingPromises: {\n            files: new Map(),\n            links: new Map(),\n          },\n          message: undefined,\n        })\n        // 重置清理上下文按钮\n        setShowRollbackThreadButton(false)\n        // 如果提交成功，添加到输入历史 (非手机端)\n        if (platform.type !== 'mobile' && preConstructedMessage.message) {\n          addInputBoxHistory(preConstructedMessage.message.contentParts.find((p) => p.type === 'text')?.text || '')\n        }\n\n        await onSubmit?.(params)\n        trackingEvent('send_message', { event_category: 'user' })\n      } catch (e) {\n        console.error('Error submitting message:', e)\n        toastActions.add((e as Error)?.message || t('An error occurred while sending the message.'))\n      } finally {\n        setIsSubmitting(false)\n      }\n    }\n\n    const onMessageInput = useCallback(\n      (event: React.ChangeEvent<HTMLTextAreaElement>) => {\n        const input = event.target.value\n        setMessageInput(input)\n        resetHistoryIndex()\n      },\n      [setMessageInput, resetHistoryIndex]\n    )\n\n    const onKeyDown = (event: React.KeyboardEvent<HTMLTextAreaElement>) => {\n      const isPressedHash: Record<ShortcutSendValue, boolean> = {\n        '': false,\n        Enter: event.keyCode === 13 && !event.shiftKey && !event.ctrlKey && !event.altKey && !event.metaKey,\n        'CommandOrControl+Enter': event.keyCode === 13 && (event.ctrlKey || event.metaKey) && !event.shiftKey,\n        'Ctrl+Enter': event.keyCode === 13 && event.ctrlKey && !event.shiftKey,\n        'Command+Enter': event.keyCode === 13 && event.metaKey,\n        'Shift+Enter': event.keyCode === 13 && event.shiftKey,\n        'Ctrl+Shift+Enter': event.keyCode === 13 && event.ctrlKey && event.shiftKey,\n      }\n\n      // 发送消息\n      if (isPressedHash[shortcuts.inputBoxSendMessage]) {\n        if (platform.type === 'mobile' && isSmallScreen && shortcuts.inputBoxSendMessage === 'Enter') {\n          // 移动端点击回车不会发送消息\n          return\n        }\n        event.preventDefault()\n        handleSubmit()\n        return\n      }\n\n      // 发送消息但不生成回复\n      if (isPressedHash[shortcuts.inputBoxSendMessageWithoutResponse]) {\n        event.preventDefault()\n        handleSubmit(false)\n        return\n      }\n\n      // 向上向下键翻阅历史消息\n      if (\n        (event.key === 'ArrowUp' || event.key === 'ArrowDown') &&\n        inputRef.current &&\n        inputRef.current === document.activeElement && // 聚焦在输入框\n        (messageInput.length === 0 || window.getSelection()?.toString() === messageInput) // 要么为空，要么输入框全选\n      ) {\n        event.preventDefault()\n        if (event.key === 'ArrowUp') {\n          const previousInput = getPreviousHistoryInput()\n          if (previousInput !== undefined) {\n            setMessageInput(previousInput)\n            setTimeout(() => inputRef.current?.select(), 10)\n          }\n        } else if (event.key === 'ArrowDown') {\n          const nextInput = getNextHistoryInput()\n          if (nextInput !== undefined) {\n            setMessageInput(nextInput)\n            setTimeout(() => inputRef.current?.select(), 10)\n          }\n        }\n      }\n    }\n\n    const startNewThread = () => {\n      const res = onStartNewThread?.()\n      if (res) {\n        setShowRollbackThreadButton(true)\n      }\n    }\n\n    const rollbackThread = () => {\n      const res = onRollbackThread?.()\n      if (res) {\n        setShowRollbackThreadButton(false)\n      }\n    }\n\n    // ----- Preprocessing helpers -----\n    const startLinkPreprocessing = (url: string) => {\n      // 设置为处理中状态\n      setPreConstructedMessage((prev) => markLinkProcessing(prev, url))\n\n      // 异步预处理链接，失败时标记为 error，并吞掉异常避免 Promise.all reject\n      const preprocessPromise = sessionHelpers\n        .preprocessLink(url, { provider: model?.provider || '', modelId: model?.modelId || '' })\n        .then((preprocessedLink) => {\n          setPreConstructedMessage((prev) => onLinkProcessed(prev, url, preprocessedLink, 6))\n        })\n        .catch((error) => {\n          setPreConstructedMessage((prev) =>\n            onLinkProcessed(\n              prev,\n              url,\n              {\n                url,\n                title: '',\n                content: '',\n                storageKey: '',\n                error: (error as Error)?.message || 'Failed to preprocess the link.',\n              },\n              6\n            )\n          )\n        })\n\n      // Store the promise\n      setPreConstructedMessage((prev) => storeLinkPromise(prev, url, preprocessPromise))\n    }\n\n    const startFilePreprocessing = (file: File) => {\n      // 设置为处理中状态\n      setPreConstructedMessage((prevMsg) => markFileProcessing(prevMsg, file))\n\n      // 异步预处理文件，失败时标记为 error，并吞掉异常避免 Promise.all reject\n      const preprocessPromise = sessionHelpers\n        .preprocessFile(file, { provider: model?.provider || '', modelId: model?.modelId || '' })\n        .then((preprocessedFile) => {\n          setPreConstructedMessage((prev) => onFileProcessed(prev, file, preprocessedFile, 10))\n        })\n        .catch((error) => {\n          setPreConstructedMessage((prev) =>\n            onFileProcessed(\n              prev,\n              file,\n              {\n                file,\n                content: '',\n                storageKey: '',\n                error: (error as Error)?.message || 'Failed to preprocess the file.',\n              },\n              10\n            )\n          )\n        })\n\n      // Store the promise\n      setPreConstructedMessage((prev) => storeFilePromise(prev, file, preprocessPromise))\n    }\n\n    const insertLinks = async (urls: string[]) => {\n      let newLinks = [...(links || []), ...urls.map((u) => ({ url: u }))]\n      newLinks = _.uniqBy(newLinks, 'url')\n      newLinks = newLinks.slice(-6) // 最多插入 6 个链接\n      setLinks(newLinks)\n\n      // 预处理链接（只处理前6个）\n      for (let i = 0; i < Math.min(urls.length, 6); i++) {\n        const url = urls[i]\n        const linkIndex = newLinks.findIndex((l) => l.url === url)\n\n        if (linkIndex < 6) {\n          startLinkPreprocessing(url)\n        }\n      }\n    }\n\n    const insertFiles = async (files: File[]) => {\n      for (const file of files) {\n        // 文件和图片插入方法复用，会导致 svg、gif 这类不支持的图片也被插入，但暂时没看到有什么问题\n        if (file.type.startsWith('image/')) {\n          const base64 = await picUtils.getImageBase64AndResize(file)\n          const key = StorageKeyGenerator.picture('input-box')\n          await storage.setBlob(key, base64)\n          setPreConstructedMessage((prev) => ({\n            ...prev,\n            pictureKeys: [...(prev.pictureKeys || []), key].slice(-8),\n          })) // 最多插入 8 个图片\n        } else {\n          setPreConstructedMessage((prev) => {\n            const newAttachments = prev.attachments.find(\n              (f) => StorageKeyGenerator.fileUniqKey(f) === StorageKeyGenerator.fileUniqKey(file)\n            )\n              ? prev.attachments\n              : [...(prev.attachments || []), file].slice(-10) // 最多插入 10 个附件\n\n            // 只预处理前10个文件，避免浪费资源\n            const fileIndex = newAttachments.findIndex(\n              (f) => f.name === file.name && f.lastModified === file.lastModified\n            )\n            if (fileIndex < 10) {\n              startFilePreprocessing(file)\n            }\n\n            return {\n              ...prev,\n              attachments: newAttachments,\n            }\n          })\n        }\n      }\n    }\n\n    const onFileInputChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n      if (!event.target.files) {\n        return\n      }\n      insertFiles(Array.from(event.target.files))\n      event.target.value = ''\n      dom.focusMessageInput()\n    }\n\n    const onImageUploadClick = () => {\n      pictureInputRef.current?.click()\n    }\n    const onFileUploadClick = () => {\n      fileInputRef.current?.click()\n    }\n\n    const onImageDeleteClick = async (picKey: string) => {\n      setPreConstructedMessage((prev) => ({\n        ...prev,\n        pictureKeys: (prev.pictureKeys || []).filter((k) => k !== picKey),\n      }))\n      // 不删除图片数据，因为可能在其他地方引用，比如通过上下键盘的历史消息快捷输入、发送的消息中引用\n      // await storage.delBlob(picKey)\n    }\n\n    const onPaste = (event: React.ClipboardEvent<HTMLTextAreaElement>) => {\n      if (sessionType === 'picture') {\n        return\n      }\n      if (event.clipboardData?.items) {\n        // 对于 Doc/PPT/XLS 等文件中的内容，粘贴时一般会有 4 个 items，分别是 text 文本、html、某格式和图片\n        // 因为 getAsString 为异步操作，无法根据 items 中的内容来定制不同的粘贴行为，因此这里选择了最简单的做法：\n        // 保持默认的粘贴行为，这时候会粘贴从文档中复制的文本和图片。我认为应该保留图片，因为文档中的表格、图表等图片信息也很重要，很难通过文本格式来表述。\n        // 仅在只粘贴图片或文件时阻止默认行为，防止插入文件或图片的名字\n        let hasText = false\n        for (let i = 0; i < event.clipboardData.items.length; i++) {\n          const item = event.clipboardData.items[i]\n          if (item.kind === 'file') {\n            // Insert files and images\n            const file = item.getAsFile()\n            if (file) {\n              insertFiles([file])\n            }\n            continue\n          }\n          hasText = true\n          if (item.kind === 'string' && item.type === 'text/plain') {\n            // 插入链接：如果复制的是链接，则插入链接\n            item.getAsString((text) => {\n              const raw = text.trim()\n              if (raw.startsWith('http://') || raw.startsWith('https://')) {\n                const urls = raw\n                  .split(/\\s+/)\n                  .map((url) => url.trim())\n                  .filter((url) => url.startsWith('http://') || url.startsWith('https://'))\n                insertLinks(urls)\n              }\n              if (pasteLongTextAsAFile && raw.length > 3000) {\n                const file = new File([text], `pasted_text_${attachments?.length || 0}.txt`, {\n                  type: 'text/plain',\n                })\n                insertFiles([file])\n                setMessageInput(messageInput) // 删除掉默认粘贴进去的长文本\n              }\n            })\n          }\n        }\n        // 如果没有任何文本，则说明只是复制了图片或文件。这里阻止默认行为，防止插入文件或图片的名字\n        if (!hasText) {\n          event.preventDefault()\n        }\n      }\n    }\n\n    const handleAttachLink = async () => {\n      const links: string[] = await NiceModal.show('attach-link')\n      if (links) {\n        insertLinks(links)\n      }\n    }\n\n    // 拖拽上传\n    const { getRootProps, getInputProps } = useDropzone({\n      onDrop: (acceptedFiles: File[]) => {\n        insertFiles(acceptedFiles)\n      },\n      noClick: true,\n      noKeyboard: true,\n    })\n\n    // 引用消息\n    const quote = useUIStore((state) => state.quote)\n    const setQuote = useUIStore((state) => state.setQuote)\n    // const [quote, setQuote] = useUIStore(state => [state]) useAtom(atoms.quoteAtom)\n    // biome-ignore lint/correctness/useExhaustiveDependencies: todo\n    useEffect(() => {\n      if (quote !== '') {\n        // TODO: 支持引用消息中的图片\n        // TODO: 支持引用消息中的文件\n        setQuote('')\n        setMessageInput((val) => {\n          const newValue = !val\n            ? quote\n            : val + '\\n'.repeat(Math.max(0, 2 - (val.match(/(\\n)+$/)?.[0].length || 0))) + quote\n          return newValue\n        })\n        // setPreviousMessageQuickInputMark('')\n        dom.focusMessageInput()\n        dom.setMessageInputCursorToEnd()\n      }\n    }, [quote])\n\n    const handleKnowledgeBaseSelect = useCallback(\n      (kb: KnowledgeBase | null) => {\n        if (!kb || kb.id === knowledgeBase?.id) {\n          setKnowledgeBase(undefined)\n          trackEvent('knowledge_base_disabled', { knowledge_base_name: knowledgeBase?.name })\n        } else {\n          setKnowledgeBase(pick(kb, 'id', 'name'))\n          trackEvent('knowledge_base_enabled', { knowledge_base_name: kb.name })\n        }\n      },\n      [knowledgeBase, setKnowledgeBase]\n    )\n\n    return (\n      <Box\n        pt={0}\n        pb={isSmallScreen ? 'md' : 'sm'}\n        px={isSmallScreen ? '0.3rem' : '1rem'}\n        id={dom.InputBoxID}\n        {...getRootProps()}\n      >\n        <input className=\"hidden\" {...getInputProps()} />\n        <Stack\n          className={cn(\n            'rounded-lg sm:rounded-md bg-chatbox-background-secondary border border-solid border-chatbox-border-primary justify-between',\n            widthFull ? 'w-full' : 'max-w-4xl mx-auto',\n            !isSmallScreen && 'min-h-[92px]'\n          )}\n          gap={0}\n        >\n          <Textarea\n            unstyled={true}\n            classNames={{\n              input:\n                'block w-full outline-none border-none px-sm pt-sm pb-sm resize-none bg-transparent text-chatbox-tint-primary',\n            }}\n            size=\"sm\"\n            id={dom.messageInputID}\n            ref={inputRef}\n            placeholder={t('Type your question here...') || ''}\n            bg=\"transparent\"\n            autosize={true}\n            minRows={1}\n            maxRows={Math.max(3, Math.floor(viewportHeight / 100))}\n            value={messageInput}\n            autoFocus={!isSmallScreen}\n            onChange={onMessageInput}\n            onKeyDown={onKeyDown}\n            onPaste={onPaste}\n          />\n\n          {(!!pictureKeys.length || !!attachments.length || !!links.length) && (\n            <Flex px=\"sm\" pb=\"xs\" align=\"center\" wrap=\"wrap\" onClick={() => dom.focusMessageInput()}>\n              {pictureKeys?.map((picKey) => (\n                <ImageMiniCard key={picKey} storageKey={picKey} onDelete={() => onImageDeleteClick(picKey)} />\n              ))}\n              {attachments?.map((file) => (\n                <FileMiniCard\n                  key={StorageKeyGenerator.fileUniqKey(file)}\n                  name={file.name}\n                  fileType={file.type}\n                  status={preConstructedMessage.preprocessingStatus.files[StorageKeyGenerator.fileUniqKey(file)]}\n                  onDelete={() => {\n                    setPreConstructedMessage((prev) => ({\n                      ...cleanupFile(prev, file),\n                      attachments: (prev.attachments || []).filter(\n                        (f) => StorageKeyGenerator.fileUniqKey(f) !== StorageKeyGenerator.fileUniqKey(file)\n                      ),\n                    }))\n                  }}\n                />\n              ))}\n              {links?.map((link) => (\n                <LinkMiniCard\n                  key={StorageKeyGenerator.linkUniqKey(link.url)}\n                  url={link.url}\n                  status={preConstructedMessage.preprocessingStatus.links[StorageKeyGenerator.linkUniqKey(link.url)]}\n                  onDelete={() => {\n                    setLinks(links.filter((l) => l.url !== link.url))\n                    setPreConstructedMessage((prev) => cleanupLink(prev, link.url))\n                  }}\n                />\n              ))}\n            </Flex>\n          )}\n\n          <Flex px=\"sm\" pb=\"sm\" align=\"flex-end\" justify=\"space-between\" gap=\"0\" wrap=\"wrap\">\n            <Flex gap=\"md\" flex=\"0 1 auto\" className=\"!hidden sm:!flex\">\n              {sessionType !== 'picture' && (\n                <>\n                  <ImageUploadInput ref={pictureInputRef} onChange={onFileInputChange} />\n                  <input type=\"file\" ref={fileInputRef} className=\"hidden\" onChange={onFileInputChange} multiple />\n\n                  <AttachmentMenu\n                    onImageUploadClick={onImageUploadClick}\n                    onFileUploadClick={onFileUploadClick}\n                    handleAttachLink={handleAttachLink}\n                    t={t}\n                  />\n\n                  {featureFlags.mcp && (\n                    <MCPMenu>\n                      {(enabledTools) =>\n                        enabledTools > 0 ? (\n                          <Button radius=\"md\" variant=\"light\" h=\"auto\" w=\"auto\" px=\"xs\" py={0}>\n                            <Flex gap=\"3xs\" align=\"center\">\n                              <ScalableIcon icon={IconHammer} strokeWidth={1.8} size={22} />\n                              <span>{enabledTools}</span>\n                            </Flex>\n                          </Button>\n                        ) : (\n                          <ActionIcon size={24} variant=\"subtle\" color=\"chatbox-secondary\">\n                            <ScalableIcon icon={IconHammer} size={22} strokeWidth={1.8} />\n                          </ActionIcon>\n                        )\n                      }\n                    </MCPMenu>\n                  )}\n                  {featureFlags.knowledgeBase && (\n                    <KnowledgeBaseMenu currentKnowledgeBaseId={knowledgeBase?.id} onSelect={handleKnowledgeBaseSelect}>\n                      <ActionIcon\n                        size={24}\n                        variant=\"subtle\"\n                        color={knowledgeBase ? 'chatbox-brand' : 'chatbox-secondary'}\n                      >\n                        <ScalableIcon icon={IconVocabulary} size={22} strokeWidth={1.8} />\n                      </ActionIcon>\n                    </KnowledgeBaseMenu>\n                  )}\n\n                  <Tooltip\n                    label={\n                      <Stack align=\"center\" gap=\"xxs\" pb=\"xxs\">\n                        <div className=\"whitespace-nowrap\">{t('Web Browsing')}</div>\n                        <Flex align=\"center\">\n                          <Keys keys={shortcuts.inputBoxWebBrowsingMode.split('+')} size=\"small\" opacity={0.7} />\n                        </Flex>\n                      </Stack>\n                    }\n                    withArrow\n                    position=\"top\"\n                  >\n                    <WebBrowsingButton\n                      active={webBrowsingMode}\n                      onClick={() => {\n                        setWebBrowsingMode(!webBrowsingMode)\n                        dom.focusMessageInput()\n                      }}\n                    />\n                  </Tooltip>\n\n                  {showRollbackThreadButton ? (\n                    <Tooltip label={t('Back to Previous')} withArrow position=\"top-start\">\n                      <ActionIcon size={24} variant=\"subtle\" color=\"chatbox-secondary\" onClick={rollbackThread}>\n                        <ScalableIcon icon={IconArrowBackUp} size={22} strokeWidth={1.8} />\n                      </ActionIcon>\n                    </Tooltip>\n                  ) : (\n                    <Tooltip\n                      label={\n                        <Stack align=\"center\" gap=\"xxs\" pb=\"xxs\">\n                          <div className=\"whitespace-nowrap\">{t('Start a New Thread')}</div>\n                          <Flex align=\"center\">\n                            <Keys keys={shortcuts.messageListRefreshContext.split('+')} size=\"small\" opacity={0.7} />\n                          </Flex>\n                        </Stack>\n                      }\n                      withArrow\n                      position=\"top-start\"\n                    >\n                      <ActionIcon\n                        size={24}\n                        variant=\"subtle\"\n                        color=\"chatbox-secondary\"\n                        disabled={!onStartNewThread}\n                        onClick={startNewThread}\n                      >\n                        <ScalableIcon icon={IconFilePencil} size={22} strokeWidth={1.8} />\n                      </ActionIcon>\n                    </Tooltip>\n                  )}\n                </>\n              )}\n              {model?.provider === ModelProviderEnum.ChatboxAI && sessionType === 'picture' && (\n                <>\n                  <ImageUploadInput ref={pictureInputRef} onChange={onFileInputChange} />\n                  <ImageUploadButton onClick={onImageUploadClick} tooltipLabel={t('Attach Image')} />\n                </>\n              )}\n              <SessionSettingsButton\n                onClick={onClickSessionSettings}\n                tooltipLabel={t('Customize settings for the current conversation')}\n                disabled={!onClickSessionSettings}\n              />\n            </Flex>\n\n            <Flex className=\"sm:!hidden\" gap=\"xs\">\n              {sessionType !== 'picture' ? (\n                <>\n                  <AttachmentMenu\n                    onImageUploadClick={onImageUploadClick}\n                    onFileUploadClick={onFileUploadClick}\n                    handleAttachLink={handleAttachLink}\n                    t={t}\n                    size={20}\n                    iconSize={undefined}\n                  />\n\n                  <WebBrowsingButton\n                    active={webBrowsingMode}\n                    onClick={() => {\n                      setWebBrowsingMode(!webBrowsingMode)\n                      dom.focusMessageInput()\n                    }}\n                    isMobile\n                  />\n\n                  <Menu\n                    trigger={isSmallScreen ? 'click' : 'hover'}\n                    openDelay={100}\n                    closeDelay={100}\n                    keepMounted\n                    transitionProps={{\n                      transition: 'pop',\n                      duration: 200,\n                    }}\n                  >\n                    <Menu.Target>\n                      <ActionIcon\n                        variant=\"transparent\"\n                        w={20}\n                        h={20}\n                        miw={20}\n                        mih={20}\n                        bd=\"none\"\n                        color=\"chatbox-secondary\"\n                      >\n                        <ScalableIcon icon={IconSettings} size={20} strokeWidth={1.8} />\n                      </ActionIcon>\n                    </Menu.Target>\n                    <Menu.Dropdown>\n                      <Menu.Item leftSection={<ScalableIcon icon={IconPlus} size={16} />} onClick={startNewThread}>\n                        {t('New Thread')}\n                      </Menu.Item>\n                      <Menu.Item\n                        leftSection={<ScalableIcon icon={IconAdjustmentsHorizontal} size={16} />}\n                        onClick={onClickSessionSettings}\n                      >\n                        {t('Conversation Settings')}\n                      </Menu.Item>\n                    </Menu.Dropdown>\n                  </Menu>\n                </>\n              ) : (\n                <>\n                  {model?.provider === ModelProviderEnum.ChatboxAI && (\n                    <>\n                      <ImageUploadInput ref={pictureInputRef} onChange={onFileInputChange} />\n                      <ImageUploadButton onClick={onImageUploadClick} tooltipLabel={t('Add images')} isMobile />\n                    </>\n                  )}\n                  <SessionSettingsButton\n                    onClick={onClickSessionSettings}\n                    tooltipLabel={t('Customize settings for the current conversation')}\n                    disabled={!onClickSessionSettings}\n                    isMobile\n                  />\n                </>\n              )}\n            </Flex>\n\n            <Flex gap={isSmallScreen ? 'xxs' : 'sm'} align=\"flex-end\" justify=\"flex-end\" flex=\"1 1 auto \">\n              {/* Wrap TokenCountMenu and ModelSelector in a Flex with center alignment */}\n              <Flex gap={isSmallScreen ? 'xxs' : 'sm'} align=\"center\">\n                {/* Token count display */}\n                {sessionType !== 'picture' && (\n                  <TokenCountMenu\n                    currentInputTokens={currentInputTokens}\n                    contextTokens={contextTokens}\n                    totalTokens={totalTokens}\n                    contextWindow={modelInfo?.contextWindow}\n                    currentMessageCount={currentContextMessageIds?.length ?? 0}\n                    maxContextMessageCount={currentSessionMergedSettings?.maxContextMessageCount}\n                    onCompressClick={sessionId && !isNewSession ? () => setShowCompressionModal(true) : undefined}\n                  >\n                    <Flex\n                      align=\"center\"\n                      gap=\"2\"\n                      className=\"text-xs text-chatbox-tint-secondary cursor-pointer hover:text-chatbox-tint-primary transition-colors\"\n                    >\n                      <ScalableIcon icon={IconArrowUp} size={14} />\n                      <Text span size=\"xs\" className=\"whitespace-nowrap\">\n                        {formatNumber(totalTokens)}\n                        {!isSmallScreen && modelInfo?.contextWindow && ` / ${formatNumber(modelInfo.contextWindow)}`}\n                      </Text>\n                    </Flex>\n                  </TokenCountMenu>\n                )}\n\n                <Tooltip\n                  label={\n                    <Flex align=\"center\" c=\"white\" gap=\"xxs\">\n                      <ScalableIcon icon={IconAlertCircle} size={12} className=\"text-inherit\" />\n                      <Text span size=\"xxs\" c=\"white\">\n                        {t('Please select a model')}\n                      </Text>\n                    </Flex>\n                  }\n                  color=\"dark\"\n                  opened={showSelectModelErrorTip}\n                  withArrow\n                >\n                  {sessionType === 'picture' ? (\n                    <ImageModelSelect onSelect={onSelectModel}>\n                      <span className=\"flex items-center text-sm cursor-pointer bg-transparent h-6\">\n                        {providers.find((p) => p.id === model?.provider)?.name || model?.provider || t('Select Model')}\n                        <ScalableIcon icon={IconSelector} size={16} className=\"opacity-50\" />\n                      </span>\n                    </ImageModelSelect>\n                  ) : (\n                    <ModelSelector\n                      onSelect={onSelectModel}\n                      selectedProviderId={model?.provider}\n                      selectedModelId={model?.modelId}\n                      position=\"top-end\"\n                      transitionProps={{\n                        transition: 'fade-up',\n                        duration: 200,\n                      }}\n                    >\n                      <Flex gap=\"xxs\" px={isSmallScreen ? 0 : 'xs'} align=\"center\" className={cn('cursor-pointer')}>\n                        {!!model && <ProviderImageIcon size={isSmallScreen ? 20 : 24} provider={model.provider} />}\n                        <Text size={isSmallScreen ? 'xs' : 'sm'} className=\"line-clamp-1\">\n                          {modelSelectorDisplayText}\n                        </Text>\n                        <ScalableIcon\n                          icon={IconSelector}\n                          size={20}\n                          className=\"flex-[0_0_auto] text-chatbox-tint-tertiary\"\n                        />\n                      </Flex>\n                    </ModelSelector>\n                  )}\n                </Tooltip>\n              </Flex>\n\n              <ActionIcon\n                disabled={(disableSubmit || isPreprocessing || isSubmitting) && !generating}\n                radius={18}\n                size={isSmallScreen ? 28 : 36}\n                onClick={generating ? onStopGenerating : () => handleSubmit()}\n                className={cn(\n                  // 'mt-[-6px] mb-[2px]',\n                  (disableSubmit || isPreprocessing || isSubmitting) &&\n                    !generating &&\n                    '!text-white !bg-chatbox-background-tertiary'\n                )}\n              >\n                {generating ? (\n                  <ScalableIcon icon={IconPlayerStopFilled} size={20} />\n                ) : (\n                  <ScalableIcon icon={IconArrowUp} size={20} />\n                )}\n              </ActionIcon>\n            </Flex>\n          </Flex>\n        </Stack>\n        {currentSession && (\n          <CompressionModal\n            opened={showCompressionModal}\n            onClose={() => setShowCompressionModal(false)}\n            session={currentSession}\n          />\n        )}\n      </Box>\n    )\n  }\n)\n\n// Reusable attachment menu component\nconst AttachmentMenu: React.FC<{\n  onImageUploadClick: () => void\n  onFileUploadClick: () => void\n  handleAttachLink: () => void\n  t: (key: string) => string\n  size?: number\n  iconSize?: number\n}> = ({ onImageUploadClick, onFileUploadClick, handleAttachLink, t, size = 24, iconSize = 20 }) => {\n  const isSmallScreen = useIsSmallScreen()\n  return (\n    <Menu\n      shadow=\"md\"\n      trigger={isSmallScreen ? 'click' : 'hover'}\n      position=\"top-start\"\n      openDelay={100}\n      closeDelay={100}\n      keepMounted\n      transitionProps={{\n        transition: 'pop',\n        duration: 200,\n      }}\n    >\n      <Menu.Target>\n        <ActionIcon\n          size={size === 20 ? undefined : `${size}px`}\n          variant={size === 20 ? 'transparent' : 'subtle'}\n          color=\"chatbox-secondary\"\n          {...(size === 20 ? { w: 20, h: 20, miw: 20, mih: 20, bd: 'none' } : {})}\n        >\n          <ScalableIcon icon={IconCirclePlus} strokeWidth={1.8} size={iconSize} />\n        </ActionIcon>\n      </Menu.Target>\n      <Menu.Dropdown>\n        <Menu.Item leftSection={<ScalableIcon icon={IconPhoto} size={16} />} onClick={onImageUploadClick}>\n          {t('Attach Image')}\n        </Menu.Item>\n        <Menu.Item leftSection={<ScalableIcon icon={IconFolder} size={16} />} onClick={onFileUploadClick}>\n          {t('Select File')}\n        </Menu.Item>\n        <Menu.Item leftSection={<ScalableIcon icon={IconLink} size={16} />} onClick={handleAttachLink}>\n          {t('Attach Link')}\n        </Menu.Item>\n      </Menu.Dropdown>\n    </Menu>\n  )\n}\n\n// Memoize the InputBox component to prevent unnecessary re-renders during streaming\nexport default React.memo(InputBox)\n","import { useAtomValue } from 'jotai'\nimport { useCallback } from 'react'\nimport type { KnowledgeBase } from 'src/shared/types'\nimport * as atoms from '@/stores/atoms'\nimport { useUIStore } from '@/stores/uiStore'\n\nexport function useKnowledgeBase({ isNewSession }: { isNewSession: boolean }) {\n  const currentSessionId = useAtomValue(atoms.currentSessionIdAtom)\n\n  const newSessionState = useUIStore((s) => s.newSessionState)\n  const setNewSessionState = useUIStore((s) => s.setNewSessionState)\n  const sessionKnowledgeBaseMap = useUIStore((s) => s.sessionKnowledgeBaseMap)\n  const addSessionKnowledgeBase = useUIStore((s) => s.addSessionKnowledgeBase)\n  const removeSessionKnowledgeBase = useUIStore((s) => s.removeSessionKnowledgeBase)\n\n  const knowledgeBase = isNewSession\n    ? newSessionState.knowledgeBase\n    : currentSessionId\n      ? sessionKnowledgeBaseMap[currentSessionId]\n      : undefined\n  const setKnowledgeBase = useCallback(\n    (value: Pick<KnowledgeBase, 'id' | 'name'> | undefined) => {\n      if (isNewSession) {\n        setNewSessionState((prev) => ({ ...prev, knowledgeBase: value }))\n      } else if (currentSessionId) {\n        if (value === undefined) {\n          removeSessionKnowledgeBase(currentSessionId)\n        } else {\n          addSessionKnowledgeBase(currentSessionId, value)\n        }\n      }\n    },\n    [currentSessionId, isNewSession, setNewSessionState, addSessionKnowledgeBase, removeSessionKnowledgeBase]\n  )\n  return { knowledgeBase, setKnowledgeBase }\n}\n","export function delay(ms: number): Promise<void> {\n  return new Promise((resolve) => {\n    setTimeout(resolve, ms)\n  })\n}\n","import { ActionIcon, Tooltip } from '@mantine/core'\nimport { IconAdjustmentsHorizontal } from '@tabler/icons-react'\nimport { forwardRef } from 'react'\nimport { ScalableIcon } from '../ScalableIcon'\nimport { desktopActionIconProps, mobileActionIconProps } from './actionIconStyles'\n\ninterface SessionSettingsButtonProps {\n  onClick?: () => void | boolean | Promise<boolean>\n  tooltipLabel: string\n  disabled?: boolean\n  isMobile?: boolean\n  size?: string | number\n  variant?: string\n}\n\nexport const SessionSettingsButton = forwardRef<HTMLButtonElement, SessionSettingsButtonProps>(\n  ({ onClick, tooltipLabel, disabled = false, isMobile = false, size, variant }, ref) => {\n    const actionIconProps = isMobile\n      ? { ...mobileActionIconProps, color: 'chatbox-secondary' }\n      : {\n          ...desktopActionIconProps,\n          size: size || desktopActionIconProps.size,\n          variant: variant || desktopActionIconProps.variant,\n        }\n\n    return (\n      <Tooltip label={tooltipLabel} withArrow position=\"top-start\">\n        <ActionIcon ref={ref} {...actionIconProps} disabled={disabled || !onClick} onClick={onClick}>\n          <ScalableIcon icon={IconAdjustmentsHorizontal} size={22} strokeWidth={1.8} />\n        </ActionIcon>\n      </Tooltip>\n    )\n  }\n)\n\nSessionSettingsButton.displayName = 'SessionSettingsButton'\n","import { ActionIcon } from '@mantine/core'\nimport { IconWorld } from '@tabler/icons-react'\nimport { forwardRef } from 'react'\nimport { ScalableIcon } from '../ScalableIcon'\nimport { desktopActionIconProps, mobileActionIconProps } from './actionIconStyles'\n\ninterface WebBrowsingButtonProps {\n  active: boolean\n  onClick: () => void\n  isMobile?: boolean\n  size?: string | number\n  variant?: string\n}\n\nexport const WebBrowsingButton = forwardRef<HTMLButtonElement, WebBrowsingButtonProps>(\n  ({ active, onClick, isMobile = false, size, variant }, ref) => {\n    const actionIconProps = isMobile\n      ? { ...mobileActionIconProps, color: active ? 'chatbox-brand' : 'chatbox-secondary' }\n      : {\n          ...desktopActionIconProps,\n          size: size || desktopActionIconProps.size,\n          variant: variant || desktopActionIconProps.variant,\n          color: active ? 'chatbox-brand' : 'chatbox-secondary',\n        }\n\n    return (\n      <ActionIcon ref={ref} {...actionIconProps} onClick={onClick}>\n        <ScalableIcon icon={IconWorld} size={22} strokeWidth={1.8} />\n      </ActionIcon>\n    )\n  }\n)\n\nWebBrowsingButton.displayName = 'WebBrowsingButton'\n","export const mobileActionIconProps = {\n  variant: 'transparent' as const,\n  w: 20,\n  h: 20,\n  miw: 20,\n  mih: 20,\n  bd: 'none',\n}\n\nexport const desktopActionIconProps = {\n  size: '24px',\n  variant: 'subtle' as const,\n  color: 'chatbox-secondary',\n}\n"],"names":["ImageUploadButton","forwardRef","onClick","tooltipLabel","isMobile","size","variant","ref","actionIconProps","color","label","withArrow","position","strokeWidth","displayName","ImageUploadInput","onChange","accept","multiple","className","style","type","display","inputBoxHistoryAtom","currentHistoryIndex","setCurrentHistoryIndex","useState","inputBoxHistory","setInputBoxHistory","addInputBoxHistory","input","filter","h","slice","clearInputBoxHistory","getPreviousHistoryInput","length","previousIndex","getNextHistoryInput","nextIndex","resetHistoryIndex","DEFAULT_OPTIONS","saveDraft","timeout","isNewSession","useMessagesTokenCountQuery","sessionId","messageIds","model","session","refetch","chatStore","results","useQueries","queries","map","id","queryKey","queryFn","m","messages","find","msg","tokenCountMap","reused","console","debug","deepseek","modelId","provider","default","enabled","staleTime","useEffect","newCalcResults","result","data","async","calcResults","mu","queryClient","setQueriesData","predicate","query","includes","String","Error","update","saveMessageTokenCount","then","useMemo","sum","r","CompressionModal","opened","onClose","t","isCompressing","setIsCompressing","summary","setSummary","error","setError","isCompleted","setIsCompleted","sessionSettings","settings","lastThreeLines","split","line","trim","join","abortControllerRef","useRef","current","abort","title","centered","Stack","gap","Text","Flex","justify","Button","globalSettings","settingsStore","getState","getSettings","dependencies","uuid","maxContextMessageCount","promptMsgs","language","fullSummary","onResultChange","text","contentParts","part","abortController","AbortController","onResultChangeWithCancel","providerOptions","signal","aborted","setTimeout","err","message","whiteSpace","height","overflow","lineHeight","align","mb","ScalableIcon","icon","IconCircleCheck","c","fw","mt","onSelect","children","comboboxProps","providers","useProviders","u","avaliableProviders","p","OpenAI","Azure","combobox","onDropdownClose","resetSelectedOption","focusTarget","Combobox","store","width","withinPortal","onOptionSubmit","val","closeDropdown","Target","targetType","toggleDropdown","Dropdown","Options","mah","overflowY","Option","value","ChatboxAI","name","iconContext","icons","keys","key","replace","src","ProviderImageIcon","props","providerName","providerInfo","isCustom","iconUrl","Image","w","alt","CustomProviderIcon","providerId","iconSrc","knowledgeBases","Menu","shadow","keepMounted","transitionProps","transition","duration","Label","to","IconSettings2","kb","Item","IconFile","currentKnowledgeBaseId","IconCheck","Group","status","Tooltip","multiline","cn","state","ServerItem","item","onEnabledChange","leftSection","rightSection","Switch","checked","disabled","e","currentTarget","mcp","isPremium","enabledToolsCount","servers","s","enabledBuiltinServers","setOpened","trigger","openDelay","closeDelay","closeOnItemClick","ActionIcon","server","Divider","my","onLinkProcessed","prev","url","max","linkUniqKey","newPromises","Map","preprocessingPromises","links","delete","nextLinks","preprocessedLinks","l","preprocessingStatus","onFileProcessed","file","fileUniqKey","files","nextFiles","preprocessedFiles","cleanupFile","newFilePromises","f","undefined","currentInputTokens","contextTokens","totalTokens","contextWindow","currentMessageCount","onCompressClick","isSmallScreen","cursor","Number","MAX_SAFE_INTEGER","IconFileZip","InputBox","sessionType","generating","fullWidth","onSelectModel","onSubmit","onStopGenerating","onStartNewThread","onRollbackThread","onClickSessionSettings","viewportHeight","pasteLongTextAsAFile","shortcuts","widthFull","webBrowsingMode","inputBoxWebBrowsingMode","setWebBrowsingMode","setInputBoxWebBrowsingMode","currentSessionId","messageInput","setMessageInput","clearDraft","initialMessage","_options","options","_setMessageInput","draftRef","draftStorageKey","restoreDraft","useCallback","draft","localStorage","getItem","_debouncedStoreDraft","debounce","setItem","storeDraft","newMessage","removeItem","cancel","useMessageInput","preConstructedMessage","setPreConstructedMessage","atoms","pictureKeys","attachments","currentSession","currentSessionMergedSettings","currentContextMessageIds","knowledgeBase","setKnowledgeBase","newSessionState","setNewSessionState","sessionKnowledgeBaseMap","addSessionKnowledgeBase","removeSessionKnowledgeBase","useKnowledgeBase","showCompressionModal","setShowCompressionModal","setLinks","isSubmitting","setIsSubmitting","constructedMessage","sessionHelpers","pictureInputRef","fileInputRef","isPreprocessing","hasProcessingFiles","Object","values","some","hasProcessingLinks","disableSubmit","modelSelectorDisplayText","modelInfo","models","defaultSettings","nickname","setCurrentInputTokens","debouncedConstructedMessage","useTokenCount","showSelectModelErrorTip","setShowSelectModelErrorTip","clickEventListener","document","removeEventListener","addEventListener","showRollbackThreadButton","setShowRollbackThreadButton","tid","clearTimeout","inputRef","useImperativeHandle","setQuote","dom","closeSelectModelErrorTipCb","handleSubmit","needGenerating","ms","Promise","resolve","params","platform","event_category","toastActions","onMessageInput","event","target","startNewThread","res","startLinkPreprocessing","markLinkProcessing","preprocessPromise","preprocessedLink","catch","content","storageKey","promise","set","storeLinkPromise","startFilePreprocessing","prevMsg","markFileProcessing","preprocessedFile","storeFilePromise","insertLinks","urls","newLinks","i","Math","min","findIndex","insertFiles","startsWith","base64","picture","storage","setBlob","newAttachments","lastModified","onFileInputChange","Array","from","onImageUploadClick","click","onFileUploadClick","handleAttachLink","getRootProps","getInputProps","onDrop","acceptedFiles","noClick","noKeyboard","quote","repeat","match","handleKnowledgeBaseSelect","pick","track","knowledge_base_name","Box","pt","pb","px","Textarea","T","unstyled","classNames","placeholder","bg","autosize","minRows","maxRows","floor","autoFocus","onKeyDown","isPressedHash","Enter","keyCode","shiftKey","ctrlKey","altKey","metaKey","inputBoxSendMessage","preventDefault","inputBoxSendMessageWithoutResponse","activeElement","window","getSelection","toString","previousInput","select","nextInput","onPaste","clipboardData","items","hasText","kind","getAsString","raw","File","getAsFile","wrap","picKey","onDelete","k","onImageDeleteClick","fileType","link","newLinkPromises","cleanupLink","flex","AttachmentMenu","enabledTools","radius","py","IconHammer","IconVocabulary","opacity","WebBrowsingButton","active","IconArrowBackUp","messageListRefreshContext","IconFilePencil","SessionSettingsButton","iconSize","miw","mih","bd","IconSettings","IconPlus","IconAdjustmentsHorizontal","IconArrowUp","span","IconAlertCircle","IconSelector","ModelSelector","selectedProviderId","selectedModelId","IconPlayerStopFilled","IconCirclePlus","IconPhoto","IconFolder","IconLink","mobileActionIconProps","desktopActionIconProps"],"sourceRoot":""}